<div class="card p-4 shadow-2 border-round-xl" dir="rtl" *ngIf="batch">
    <!-- Header -->
    <div
        class="flex flex-column md:flex-row md:align-items-center justify-content-between mb-5 gap-3 border-bottom-1 border-gray-100 pb-4">
        <div class="flex align-items-center gap-3">
            <div
                class="w-4rem h-4rem border-circle bg-blue-50 flex align-items-center justify-content-center shadow-sm">
                <i class="pi pi-info-circle text-blue-600 text-2xl"></i>
            </div>
            <div>
                <h2 class="text-3xl font-bold m-0 text-gray-900">{{ batch.medicineName }}</h2>
                <div class="flex gap-3 text-secondary font-medium">
                    <span><i class="pi pi-hashtag mr-1"></i> رقم الدفعة: <span class="text-gray-900 font-mono">{{
                            batch.companyBatchNumber }}</span></span>
                    <span><i class="pi pi-barcode mr-1"></i> باركود: <span class="text-gray-900 font-mono">{{
                            batch.batchBarcode }}</span></span>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <button pButton label="تسجيل تلف/تعديل" icon="pi pi-exclamation-triangle"
                class="p-button-warning border-round-xl px-4 shadow-1" (click)="showActionDialog()"></button>
            <button pButton label="عودة" icon="pi pi-arrow-left"
                class="p-button-text p-button-secondary border-round-xl" (click)="goBack()"></button>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid mb-5">
        <div class="col-12 md:col-3">
            <div class="p-4 border-round-xl bg-gray-50 border-1 border-gray-100 text-center shadow-sm">
                <span class="block text-secondary mb-2 font-medium">الكمية الكلية</span>
                <span class="text-4xl font-bold text-gray-800">{{ batch.quantity }}</span>
            </div>
        </div>
        <div class="col-12 md:col-3">
            <div class="p-4 border-round-xl bg-blue-50 border-1 border-blue-100 text-center shadow-sm">
                <span class="block text-blue-800 mb-2 font-medium">الكمية المباعة</span>
                <span class="text-4xl font-bold text-blue-900">{{ batch.soldQuantity }}</span>
            </div>
        </div>
        <div class="col-12 md:col-3">
            <div class="p-4 border-round-xl bg-green-50 border-1 border-green-100 text-center shadow-sm">
                <span class="block text-green-800 mb-2 font-medium">الرصيد المتبقي</span>
                <span class="text-4xl font-bold text-green-900">{{ batch.remainingQuantity }}</span>
            </div>
        </div>
        <div class="col-12 md:col-3">
            <div class="p-4 border-round-xl bg-orange-50 border-1 border-orange-100 text-center shadow-sm">
                <span class="block text-orange-800 mb-2 font-medium">تاريخ الانتهاء</span>
                <span class="text-xl font-bold text-orange-900">{{ batch.expiryDate | date:'dd/MM/yyyy' }}</span>
            </div>
        </div>
    </div>

    <!-- Stock Card Table -->
    <div class="mb-4">
        <h3 class="flex align-items-center gap-2 text-gray-800 mb-3 px-2">
            <i class="pi pi-list text-primary"></i> بطاقة الصنف (سجل الحركات)
        </h3>
        <p-table [value]="stockCard" [loading]="loading" responsiveLayout="scroll"
            styleClass="p-datatable-sm p-datatable-gridlines border-round-xl overflow-hidden shadow-1 custom-table">
            <ng-template pTemplate="header">
                <tr>
                    <th class="bg-primary text-white font-bold text-center p-3">التاريخ والوقت</th>
                    <th class="bg-primary text-white font-bold p-3">النوع</th>
                    <th class="bg-primary text-white font-bold text-center p-3">المرجع</th>
                    <th class="bg-primary text-white font-bold text-center p-3">الكمية (+/-)</th>
                    <th class="bg-primary text-white font-bold text-center p-3">الرصيد بعد الحركة</th>
                    <th class="bg-primary text-white font-bold p-3">ملاحظات</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-movement>
                <tr class="transition-colors hover:bg-gray-50">
                    <td class="text-center p-3">{{ movement.date | date:'dd/MM/yyyy HH:mm' }}</td>
                    <td class="p-3">
                        <p-tag [severity]="getMovementSeverity(movement.movementType)" [value]="movement.movementType"
                            [rounded]="true" styleClass="px-3"></p-tag>
                    </td>
                    <td class="text-center p-3 font-mono text-sm">{{ movement.referenceNumber || '---' }}</td>
                    <td class="text-center p-3 font-extrabold text-lg" [class.text-green-600]="movement.quantity > 0"
                        [class.text-red-600]="movement.quantity < 0">
                        {{ movement.quantity > 0 ? '+' : '' }}{{ movement.quantity }}
                    </td>
                    <td class="text-center p-3 font-bold text-lg">{{ movement.balanceAfter }}</td>
                    <td class="p-3 text-secondary">{{ movement.notes || '---' }}</td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6" class="text-center p-8 text-secondary">
                        <i class="pi pi-history text-5xl mb-3 block text-300"></i>
                        لا توجد حركات مسجلة لهذه الدفعة.
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<div class="card p-8 text-center" *ngIf="loading">
    <i class="pi pi-spin pi-spinner text-4xl text-primary mb-3"></i>
    <p class="text-secondary font-medium">جاري تحميل تفاصيل الدفعة وسجل الحركات...</p>
</div>

<!-- Actions Dialog -->
<app-batch-actions-dialog *ngIf="displayActionDialog" [visible]="displayActionDialog" [batch]="batch"
    (onClose)="displayActionDialog = false" (onSuccess)="onActionSuccess()">
</app-batch-actions-dialog>