<div class="card p-4 shadow-2 border-round-xl" dir="rtl" *ngIf="invoice">
    <!-- Header with Actions -->
    <div
        class="flex flex-column md:flex-row md:align-items-center justify-content-between mb-5 gap-4 border-bottom-1 border-gray-100 pb-4">
        <div class="flex align-items-center gap-4">
            <div
                class="w-4rem h-4rem border-circle bg-blue-50 flex align-items-center justify-content-center shadow-sm">
                <i class="pi pi-file-o text-blue-600 text-2xl"></i>
            </div>
            <div>
                <div class="flex align-items-center gap-2 mb-1">
                    <h2 class="text-3xl font-bold m-0 text-gray-900">فاتورة مشتريات #{{ invoice.id }}</h2>
                    <p-tag [severity]="getStatusSeverity(invoice.status)" [value]="getStatusLabel(invoice.status)"
                        [rounded]="true" styleClass="px-3 text-sm"></p-tag>
                </div>
                <div class="flex gap-4 text-secondary font-medium">
                    <span><i class="pi pi-user mr-1"></i> المورد: <span class="text-gray-900">{{ invoice.supplierName
                            }}</span></span>
                    <span><i class="pi pi-calendar mr-1"></i> بتاريخ: <span class="text-gray-900">{{
                            invoice.purchaseDate | date:'dd/MM/yyyy' }}</span></span>
                </div>
            </div>
        </div>

        <div class="flex gap-2">
            <button pButton label="اعتماد الفاتورة" icon="pi pi-check-circle"
                class="p-button-success border-round-xl px-4 shadow-1 font-bold" *ngIf="invoice.status === 'DRAFT'"
                (click)="approveInvoice()"></button>
            <button pButton label="إلغاء الفاتورة" icon="pi pi-times-circle"
                class="p-button-outlined p-button-danger border-round-xl px-4 font-bold"
                *ngIf="invoice.status === 'DRAFT'" (click)="cancelInvoice()"></button>
            <button pButton label="عودة" icon="pi pi-arrow-left"
                class="p-button-text p-button-secondary border-round-xl font-bold" (click)="goBack()"></button>
        </div>
    </div>

    <!-- Invoice Info Grid -->
    <div class="grid mb-5">
        <div class="col-12 lg:col-4">
            <div class="p-4 border-round-xl bg-gray-50 border-1 border-gray-100 h-full">
                <h3 class="mt-0 mb-3 text-gray-700 flex align-items-center gap-2 font-bold"><i
                        class="pi pi-info-circle text-primary"></i>
                    معلومات التوريد</h3>
                <div class="flex flex-column gap-3">
                    <div class="flex justify-content-between">
                        <span class="text-secondary font-medium">رقم فاتورة المورد:</span>
                        <span class="font-bold font-mono text-gray-900">{{ invoice.supplierInvoiceNumber || '---'
                            }}</span>
                    </div>
                    <div class="flex justify-content-between">
                        <span class="text-secondary font-medium">طريقة الدفع:</span>
                        <span class="font-bold text-gray-900">{{ invoice.paymentMethod === 'Cash' ? 'نقدي' :
                            invoice.paymentMethod === 'Credit' ? 'آجل' : 'تحويل بنكي' }}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 lg:col-4 text-center">
            <div
                class="p-4 border-round-xl bg-green-50 border-1 border-green-100 flex flex-column justify-content-center h-full shadow-sm">
                <span class="text-green-800 text-lg mb-1 font-medium">إجمالي الفاتورة</span>
                <span class="text-4xl font-extrabold text-green-900">{{ invoice.totalAmount | currency:'EGP
                    ':'symbol':'1.2-2' }}</span>
            </div>
        </div>
        <div class="col-12 lg:col-4">
            <div class="p-4 border-round-xl bg-gray-50 border-1 border-gray-100 h-full">
                <h3 class="mt-0 mb-3 text-gray-700 flex align-items-center gap-2 font-bold"><i
                        class="pi pi-comment text-primary"></i> ملاحظات
                </h3>
                <p class="m-0 text-gray-600 line-height-3 font-medium">{{ invoice.notes || 'لا توجد ملاحظات على هذه
                    الفاتورة' }}</p>
            </div>
        </div>
    </div>

    <!-- Items Table -->
    <div class="mb-4">
        <div class="flex justify-content-between align-items-center mb-3">
            <h3 class="flex align-items-center gap-2 text-gray-800 m-0 px-2 font-bold">
                <i class="pi pi-list text-primary"></i> بنود الفاتورة
            </h3>
            <span class="text-secondary text-sm font-medium" *ngIf="invoice.status === 'APPROVED'">
                <i class="pi pi-info-circle mr-1 text-blue-500"></i> يمكنك إجراء حركات يدوية على الدفعات الموردة أدناه.
            </span>
        </div>
        <p-table [value]="invoice.purchaseInvoiceDetails || []"
            styleClass="p-datatable-gridlines p-datatable-sm border-round-xl overflow-hidden shadow-1 custom-table">
            <ng-template pTemplate="header">
                <tr>
                    <th class="bg-primary text-white font-bold p-3">الدواء</th>
                    <th class="bg-primary text-white font-bold text-center p-3" style="width: 150px">رقم الدفعة</th>
                    <th class="bg-primary text-white font-bold text-center p-3" style="width: 120px">الكمية</th>
                    <th class="bg-primary text-white font-bold text-center p-3" style="width: 150px">سعر الشراء</th>
                    <th class="bg-primary text-white font-bold text-center p-3" style="width: 150px">الإجمالي</th>
                    <th class="bg-primary text-white font-bold text-center p-3" style="width: 100px"
                        *ngIf="invoice.status === 'APPROVED'">إجراءات</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
                <tr class="transition-colors hover:bg-gray-50">
                    <td class="p-3">
                        <div class="font-bold text-gray-900">{{ item.medicineName }}</div>
                        <small class="text-secondary font-mono" *ngIf="invoice.status === 'APPROVED'">ID: {{
                            item.batchId }}</small>
                    </td>
                    <td class="text-center p-3 font-mono font-bold text-sm">{{ item.companyBatchNumber }}</td>
                    <td class="text-center p-3 font-extrabold text-blue-800">{{ item.quantity }}</td>
                    <td class="text-center p-3 text-gray-700 font-medium">{{ item.purchasePrice | number:'1.2-2' }}</td>
                    <td class="text-center p-3 font-bold text-green-700 text-lg">{{ item.total | number:'1.2-2' }}</td>
                    <td class="text-center p-3" *ngIf="invoice.status === 'APPROVED'">
                        <div class="flex justify-content-center gap-1">
                            <button pButton icon="pi pi-exclamation-triangle"
                                class="p-button-sm p-button-rounded p-button-warning p-button-text"
                                pTooltip="تسجيل تلف/تعديل" (click)="showActionDialog(item)"></button>
                            <button pButton icon="pi pi-history"
                                class="p-button-sm p-button-rounded p-button-info p-button-text"
                                pTooltip="عرض سجل الحركة"
                                [routerLink]="['/inventory/batches/details', item.batchId]"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="footer">
                <tr>
                    <td colspan="4" class="text-left font-bold p-3 bg-gray-50 text-gray-700">إجمالي الفاتورة:</td>
                    <td class="text-center font-bold p-3 bg-gray-50 text-xl text-green-800"
                        [colSpan]="invoice.status === 'APPROVED' ? 2 : 1">
                        {{ invoice.totalAmount | currency:'EGP ':'symbol':'1.2-2' }}
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <!-- Alert for Draft Invoices -->
    <div class="flex align-items-center gap-3 p-3 border-round-xl bg-orange-50 border-1 border-orange-100 mt-4 shadow-sm"
        *ngIf="invoice.status === 'DRAFT'">
        <i class="pi pi-info-circle text-orange-600 text-2xl"></i>
        <span class="text-orange-900 font-medium italic">تنبيه: هذه الفاتورة ما زالت "مسودة". لن تظهر الكميات الموردة في
            المخزن ولن يتم إنشاء حركات مخزنية إلا بعد الاعتماد النهائي.</span>
    </div>
</div>

<!-- Loading State -->
<div class="card p-8 text-center" *ngIf="loading">
    <i class="pi pi-spin pi-spinner text-4xl text-primary mb-3"></i>
    <p class="text-secondary font-medium">جاري تحميل تفاصيل الفاتورة...</p>
</div>

<!-- Confirmation for Approval/Cancellation -->
<p-confirmDialog [style]="{width: '450px'}" [rtl]="true"></p-confirmDialog>

<!-- Manual Adjustment Dialog -->
<app-batch-actions-dialog *ngIf="displayActionDialog" [visible]="displayActionDialog" [batch]="selectedBatch"
    (onClose)="displayActionDialog = false" (onSuccess)="onActionSuccess()">
</app-batch-actions-dialog>