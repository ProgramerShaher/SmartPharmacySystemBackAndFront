<div class="expenses-container">
  <!-- Header Card -->
  <p-card class="header-card">
    <div class="header-content">
      <div class="title-section">
        <i class="pi pi-money-bill header-icon"></i>
        <div>
          <h2 class="page-title">إدارة المصروفات</h2>
          <p class="page-subtitle">تتبع وإدارة جميع مصروفات الصيدلية</p>
        </div>
      </div>
      <button pButton type="button" label="إضافة مصروف جديد"
        icon="pi pi-plus-circle" 
        class="p-button-success add-btn"
        (click)="addNewExpense()"
        pTooltip="إضافة مصروف جديد"
        tooltipPosition="bottom">
      </button>
    </div>
  </p-card>
  
  <!-- Summary Cards -->
  <div class="summary-cards">
    <p-card class="summary-card total-card">
      <div class="summary-content">
        <i class="pi pi-chart-line summary-icon"></i>
        <div class="summary-details">
          <span class="summary-label">إجمالي المصروفات</span>
          <span class="summary-value">{{ formatExpenseAmount(getTotalExpenses()) }}</span>
        </div>
      </div>
      </p-card>

    <p-card class="summary-card paid-card">
      <div class="summary-content">
        <i class="pi pi-check-circle summary-icon"></i>
        <div class="summary-details">
          <span class="summary-label">المدفوع</span>
          <span class="summary-value">{{ formatExpenseAmount(getPaidExpenses()) }}</span>
        </div>
      </div>
    </p-card>
    
    <p-card class="summary-card unpaid-card">
      <div class="summary-content">
        <i class="pi pi-clock summary-icon"></i>
        <div class="summary-details">
          <span class="summary-label">غير المدفوع</span>
          <span class="summary-value">{{ formatExpenseAmount(getUnpaidExpenses()) }}</span>
        </div>
      </div>
    </p-card>
    </div>
    
    <!-- Filters Card -->
    <p-card class="filters-card">
      <div class="filters-grid">
        <!-- Search -->
        <div class="filter-field">
          <label>
            <i class="pi pi-search"></i> بحث
          </label>
          <input
          type="text" 
          pInputText 
          [(ngModel)]="searchTerm"
          (keyup.enter)="onSearch()"
          placeholder="ابحث في الملاحظات..."
          class="w-full">
      </div>
<!-- Category Filter -->
<div class="filter-field">
  <label>
    <i class="pi pi-tag"></i> الفئة
  </label>
  <p-dropdown
          [options]="categoryOptions" 
          [(ngModel)]="selectedCategory"
          (onChange)="onFilterChange()"
          placeholder="اختر الفئة"
          [showClear]="true"
          styleClass="w-full">
        </p-dropdown>
      </div>
<!-- Payment Method Filter -->
<div class="filter-field">
  <label>
    <i class="pi pi-wallet"></i> طريقة الدفع
  </label>
  <p-dropdown [options]="paymentMethodOptions" [(ngModel)]="selectedPaymentMethod" (onChange)="onFilterChange()"
    placeholder="اختر طريقة الدفع" styleClass="w-full">
  </p-dropdown>
</div>

<!-- Paid Status Filter -->
<div class="filter-field">
  <label>
    <i class="pi pi-info-circle"></i> حالة الدفع
  </label>
  <p-dropdown [options]="paidStatusOptions" [(ngModel)]="selectedPaidStatus" (onChange)="onFilterChange()"
    placeholder="اختر الحالة" styleClass="w-full">
  </p-dropdown>
</div>

<!-- Date From -->
<div class="filter-field">
  <label>
    <i class="pi pi-calendar"></i> من تاريخ
  </label>
  <p-calendar [(ngModel)]="startDate"
          (onSelect)="onFilterChange()"
          (onClearClick)="onFilterChange()"
          [showIcon]="true"
          dateFormat="yy-mm-dd"
          placeholder="اختر التاريخ"
          [showClear]="true"
          styleClass="w-full">
        </p-calendar>
      </div>

      <!-- Date To -->
      <div class="filter-field">
        <label>
          <i class="pi pi-calendar"></i> إلى تاريخ
        </label>
        <p-calendar 
          [(ngModel)]="endDate"
          (onSelect)="onFilterChange()"
          (onClearClick)="onFilterChange()"
          [showIcon]="true"
          dateFormat="yy-mm-dd"
          placeholder="اختر التاريخ"
          [showClear]="true"
          styleClass="w-full">
        </p-calendar>
      </div>
    </div>
<div class="filter-actions">
  <button pButton type="button" label="بحث" icon="pi pi-search" class="p-button-primary" (click)="onSearch()">
  </button>
  <button pButton type="button" label="مسح الفلاتر" icon="pi pi-filter-slash"
    class="p-button-outlined p-button-secondary" (click)="clearFilters()">
  </button>
    </div>
  </p-card>

  <!-- Expenses Table -->
  <p-card class="table-card">
    <p-table [value]="expenses"
      [loading]="loading"
      [paginator]="true"
      [rows]="pageSize"
      [totalRecords]="totalRecords"
      [lazy]="true"
      (onLazyLoad)="onPageChange($event)"
      [rowsPerPageOptions]="[10, 25, 50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="عرض {first} إلى {last} من {totalRecords} مصروف"
      styleClass="p-datatable-sm p-datatable-striped"
      responsiveLayout="scroll">
      
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 5%">#</th>
          <th style="width: 15%">
            <i class="pi pi-tag"></i> الفئة
          </th>
          <th style="width: 12%">
            <i class="pi pi-dollar"></i> المبلغ
          </th>
          <th style="width: 12%">
            <i class="pi pi-calendar"></i> التاريخ
          </th>
          <th style="width: 12%">
            <i class="pi pi-wallet"></i> طريقة الدفع
          </th>
          <th style="width: 10%">
            <i class="pi pi-info-circle"></i> الحالة
          </th>
          <th style="width: 24%">
            <i class="pi pi-align-right"></i> الملاحظات
          </th>
          <th style="width: 10%" class="text-center">
            <i class="pi pi-cog"></i> الإجراءات
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-expense let-rowIndex="rowIndex">
        <tr>
          <td>{{ (currentPage - 1) * pageSize + rowIndex + 1 }}</td>
          <td>
            <div class="category-cell">
              <i class="pi pi-tag category-icon"></i>
              <strong>{{ expense.categoryName }}</strong>
            </div>
          </td>
          <td>
            <span class="amount-text">{{ formatExpenseAmount(expense.amount) }}</span>
          </td>
          <td>
            <span class="date-text">{{ formatDate(expense.expenseDate) }}</span>
          </td>
          <td>
            <p-tag [value]="getPaymentMethodLabel(expense.paymentMethod)"
              [severity]="getPaymentMethodSeverity(expense.paymentMethod)">
            </p-tag>
          </td>
          <td>
            <p-tag [value]="getPaidStatusLabel(expense.isPaid)" [severity]="getPaidStatusSeverity(expense.isPaid)"
              [icon]="'pi ' + (expense.isPaid ? 'pi-check' : 'pi-clock')">
            </p-tag>
          </td>
          <td>
            <span class="notes-text">{{ expense.notes || 'لا توجد ملاحظات' }}</span>
          </td>
          <td class="text-center">
            <div class="action-buttons">
              <button pButton type="button" icon="pi pi-eye"
                class="p-button-rounded p-button-info p-button-sm"
                (click)="viewDetails(expense)"
                pTooltip="عرض التفاصيل"
                tooltipPosition="top">
              </button>
              <button 
                pButton 
                type="button" 
                icon="pi pi-pencil" 
                class="p-button-rounded p-button-warning p-button-sm"
                (click)="editExpense(expense)"
                pTooltip="تعديل"
                tooltipPosition="top">
              </button>
              <button 
                pButton 
                type="button" 
                icon="pi pi-trash" 
                class="p-button-rounded p-button-danger p-button-sm"
                (click)="deleteExpense($event, expense)"
                pTooltip="حذف"
                tooltipPosition="top">
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center empty-message">
            <i class="pi pi-inbox empty-icon"></i>
            <p>لا توجد مصروفات</p>
            <button pButton type="button" label="إضافة أول مصروف" icon="pi pi-plus" class="p-button-sm" (click)="addNewExpense()">
            </button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
  
  <!-- Toast & Confirm Dialog -->
  <p-toast position="top-center" [life]="3000"></p-toast>
  <p-confirmDialog [style]="{width: '450px'}" acceptButtonStyleClass="p-button-danger"
    rejectButtonStyleClass="p-button-text">
  </p-confirmDialog>
</div>
