    <div class="flex flex-column gap-4 animate-fade-in" dir="rtl">
        <p-toast></p-toast>
        <p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

        <!-- Header -->
        <div class="flex justify-content-between align-items-center">
            <div>
                 <h1 class="text-3xl font-bold text-900 m-0">الرقابة المالية</h1>
                 <span class="text-600">نظرة شاملة على الوضع المالي للصيدلية</span>
            </div>
            <div class="flex gap-2">
                <p-button label="تسوية يدوية" icon="pi pi-sliders-h" styleClass="p-button-outlined" (onClick)="showAdjustmentDialog()"></p-button>
                <p-button label="تحديث البيانات" icon="pi pi-refresh" (onClick)="refreshAll()"></p-button>
            </div>
        </div>

        <!-- Metric Cards -->
        <div class="grid">
            <div class="col-12 md:col-4">
                <p-card styleClass="h-full shadow-2 border-round-xl surface-card">
                    <div class="flex flex-column gap-3">
                        <div class="flex align-items-center gap-2 text-indigo-600">
                             <i class="pi pi-wallet text-2xl"></i>
                             <span class="font-bold text-lg">الرصيد الحالي</span>
                        </div>
                        <div *ngIf="loadingBalance; else balanceContent">
                            <p-skeleton width="60%" height="2rem"></p-skeleton>
                        </div>
                        <ng-template #balanceContent>
                            <span class="text-4xl font-bold text-900">{{ currentBalance | number:'1.2-2' }}</span>
                            <span class="text-sm text-500">ريال يمني</span>
                        </ng-template>
                    </div>
                </p-card>
            </div>
            
             <div class="col-12 md:col-4">
                <p-card styleClass="h-full shadow-2 border-round-xl surface-card bg-green-50">
                    <div class="flex flex-column gap-3">
                         <div class="flex align-items-center gap-2 text-green-700">
                             <i class="pi pi-arrow-down-left text-2xl"></i>
                             <span class="font-bold text-lg">إجمالي الوارد (الشهر)</span>
                        </div>
                        <div *ngIf="loadingReport; else incomeContent">
                            <p-skeleton width="60%" height="2rem"></p-skeleton>
                        </div>
                        <ng-template #incomeContent>
                             <span class="text-4xl font-bold text-green-800">{{ report?.totalIncome | number:'1.2-2' }}</span>
                             <span class="text-sm text-green-600">ريال يمني</span>
                        </ng-template>
                    </div>
                </p-card>
            </div>

            <div class="col-12 md:col-4">
                <p-card styleClass="h-full shadow-2 border-round-xl surface-card bg-red-50">
                    <div class="flex flex-column gap-3">
                         <div class="flex align-items-center gap-2 text-red-700">
                             <i class="pi pi-arrow-up-right text-2xl"></i>
                             <span class="font-bold text-lg">إجمالي المنصرف (الشهر)</span>
                        </div>
                        <div *ngIf="loadingReport; else expenseContent">
                            <p-skeleton width="60%" height="2rem"></p-skeleton>
                        </div>
                        <ng-template #expenseContent>
                             <span class="text-4xl font-bold text-red-800">{{ report?.totalExpense | number:'1.2-2' }}</span>
                             <span class="text-sm text-red-600">ريال يمني</span>
                        </ng-template>
                    </div>
                </p-card>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="card shadow-2 border-round-xl p-0 overflow-hidden">
             <p-tabView styleClass="p-tabview-custom">
                <!-- Transactions Tab -->
                <p-tabPanel header="سجل الحركات المالية">
                    <ng-template pTemplate="header">
                        <i class="pi pi-list ml-2"></i>
                        <span>سجل الحركات</span>
                    </ng-template>
                    
                    <p-table #dt [value]="transactions" [rows]="10" [paginator]="true" 
                        [loading]="loadingTransactions" styleClass="p-datatable-striped" responsiveLayout="scroll">
                        <ng-template pTemplate="caption">
                             <div class="flex flex-wrap gap-2 align-items-center justify-content-between">
                                 <span class="p-input-icon-left w-full sm:w-auto">
                                     <i class="pi pi-search"></i>
                                     <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')" placeholder="بحث في الحركات..." />
                                 </span>
                                 <p-calendar [(ngModel)]="dateFilter" selectionMode="range" [readonlyInput]="true" placeholder="تصفية بالتاريخ" (onSelect)="loadTransactions()" [showIcon]="true"></p-calendar>
                             </div>
                        </ng-template>
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 15%">التاريخ</th>
                                <th style="width: 35%">الوصف</th>
                                <th style="width: 15%">رقم المرجع (فاتورة)</th>
                                <th style="width: 15%">النوع</th>
                                <th style="width: 20%" class="text-left">المبلغ</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-tx>
                            <tr>
                                <td>{{ tx.transactionDate | date:'dd/MM/yyyy hh:mm a' }}</td>
                                <td>{{ tx.description }}</td>
                                <td>
                                    <span *ngIf="tx.relatedInvoiceId" class="text-blue-600 cursor-pointer font-bold">#{{tx.relatedInvoiceId}}</span>
                                    <span *ngIf="!tx.relatedInvoiceId">-</span>
                                </td>
                                <td>
                                    <p-tag [value]="getTransactionTypeLabel(tx.type)" [severity]="getTransactionSeverity(tx.type)" rounded="true"></p-tag>
                                </td>
                                <td class="text-left font-bold" [ngClass]="{'text-green-600': tx.type === 1, 'text-red-600': tx.type === 2}">
                                    {{ tx.type === 2 ? '-' : '+' }} {{ tx.amount | number:'1.2-2' }}
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabPanel>

                <!-- Annual Chart Tab -->
                <p-tabPanel header="التحليل السنوي">
                     <ng-template pTemplate="header">
                        <i class="pi pi-chart-bar ml-2"></i>
                        <span>التحليل السنوي</span>
                    </ng-template>

                    <div class="flex justify-content-end mb-4">
                        <p-dropdown [options]="years" [(ngModel)]="selectedYear" (onChange)="loadCharts()" label="السنة المالية"></p-dropdown>
                    </div>

                    <div class="grid" *ngIf="chartData">
                        <div class="col-12 md:col-6">
                            <p-chart type="bar" [data]="chartData" [options]="basicOptions"></p-chart>
                        </div>
                         <div class="col-12 md:col-6">
                            <p-chart type="doughnut" [data]="pieData" [options]="pieOptions"></p-chart>
                        </div>
                    </div>
                </p-tabPanel>
             </p-tabView>
        </div>

        <!-- Manual Adjustment Dialog -->
        <p-dialog header="تسوية مالية يدوية" [(visible)]="displayAdjustmentDialog" [modal]="true" [style]="{width: '450px'}" styleClass="p-fluid">
            <ng-template pTemplate="content">
                <form [formGroup]="adjustmentForm">
                    <div class="field">
                        <label for="amount">المبلغ (سالب للخصم، موجب للإضافة)</label>
                        <p-inputNumber id="amount" formControlName="amount" mode="currency" currency="YER" locale="ar-YE" class="w-full"></p-inputNumber>
                        <small class="text-secondary block mt-1">مثال: 5000 لإضافة رصيد، -2000 لخصم مصروفات نثرية</small>
                    </div>
                    <div class="field">
                        <label for="description">سبب التسوية</label>
                        <textarea id="description" pInputTextarea formControlName="description" rows="3" autoResize="autoResize" class="w-full"></textarea>
                    </div>
                </form>
            </ng-template>
            <ng-template pTemplate="footer">
                <p-button label="إلغاء" icon="pi pi-times" (onClick)="displayAdjustmentDialog = false" styleClass="p-button-text"></p-button>
                <p-button label="حفظ التسوية" icon="pi pi-check" (onClick)="saveAdjustment()" [loading]="saving"></p-button>
            </ng-template>
        </p-dialog>
    </div>
