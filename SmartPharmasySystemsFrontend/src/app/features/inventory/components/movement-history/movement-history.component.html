<div class="movements-container" dir="rtl">
    <div class="page-header">
        <h1>
            <i class="pi pi-history"></i>
            سجل الحركات المخزنية
        </h1>
        <p-button label="إضافة حركة جديدة" icon="pi pi-plus" (onClick)="createMovement()" severity="success"
            raised></p-button>
    </div>

    <div class="table-card">
        <p-table #dt [value]="movements" [lazy]="true" (onLazyLoad)="loadMovements($event)" [paginator]="true"
            [rows]="query.pageSize" [totalRecords]="totalRecords" [loading]="loading" [showCurrentPageReport]="true"
            styleClass="p-datatable-striped"
            currentPageReportTemplate="عرض {first} إلى {last} من أصل {totalRecords} حركة">

            <ng-template pTemplate="header">
                <div class="table-header">
                    <div class="search-filters">
                        <span class="search-box">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="onSearch($event)"
                                placeholder="بحث عن دواء، رقم تشغيلة، أو مرجع..." />
                        </span>

                        <p-dropdown [options]="movementTypes" [(ngModel)]="query.movementType"
                            (onChange)="onFilterChange()" styleClass="filter-dropdown"
                            placeholder="نوع الحركة"></p-dropdown>

                        <p-calendar [(ngModel)]="query.startDate" (onSelect)="onFilterChange()" placeholder="من تاريخ"
                            [showIcon]="true" dateFormat="dd/mm/yy" class="date-filter"></p-calendar>

                        <p-calendar [(ngModel)]="query.endDate" (onSelect)="onFilterChange()" placeholder="إلى تاريخ"
                            [showIcon]="true" dateFormat="dd/mm/yy" class="date-filter"></p-calendar>
                    </div>
                </div>
                <tr>
                    <th style="width: 15%">التاريخ والوقت</th>
                    <th style="width: 25%">الدواء / رقم التشغيلة</th>
                    <th style="width: 15%">نوع الحركة</th>
                    <th style="width: 10%" class="text-center">الكمية</th>
                    <th style="width: 20%">المرجع / السبب</th>
                    <th style="width: 15%" class="text-center">الإجراءات</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-movement>
                <tr>
                    <td>{{ movement.date | date:'dd/MM/yyyy HH:mm' }}</td>
                    <td>
                        <div class="medicine-cell">
                            <span class="medicine-name">{{ movement.medicine?.name }}</span>
                            <span class="batch-number" *ngIf="movement.batch?.batchNumber">رقم: {{
                                movement.batch?.batchNumber }}</span>
                        </div>
                    </td>
                    <td>
                        <p-tag [value]="getMovementTypeLabel(movement.movementType)"
                            [severity]="getMovementTypeSeverity(movement.movementType)"></p-tag>
                    </td>
                    <td class="quantity-cell">
                        <span class="qty-badge"
                            [ngClass]="movement.movementType === 'IN' ? 'text-success' : 'text-danger'">
                            {{ movement.movementType === 'IN' ? '+' : '-' }}{{ movement.quantity }}
                        </span>
                    </td>
                    <td>
                        <span class="text-secondary">{{ movement.referenceId || '---' }}</span>
                        <div class="text-xs mt-1 text-400" *ngIf="movement.notes">{{ movement.notes }}</div>
                    </td>
                    <td class="actions-cell">
                        <p-button icon="pi pi-eye" [text]="true" [rounded]="true" severity="info"
                            pTooltip="عرض التفاصيل" (onClick)="viewDetails(movement)"></p-button>
                        <p-button icon="pi pi-pencil" [text]="true" [rounded]="true" severity="success" pTooltip="تعديل"
                            (onClick)="editMovement(movement)"></p-button>
                        <p-button icon="pi pi-trash" [text]="true" [rounded]="true" severity="danger" pTooltip="حذف"
                            (onClick)="deleteMovement(movement)"></p-button>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6">
                        <div class="flex flex-column align-items-center p-5 text-secondary">
                            <i class="pi pi-info-circle text-4xl mb-3"></i>
                            <span>لا توجد حركات مخزون مطابقة للمعايير</span>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<!-- Modal للنموذج -->
<p-dialog [header]="selectedMovement ? 'تعديل حركة مخزنية' : 'إضافة حركة مخزنية جديدة'" [(visible)]="displayForm"
    [modal]="true" [style]="{width: '600px'}" [draggable]="false" [resizable]="false">
    <app-movement-form *ngIf="displayForm" [movement]="selectedMovement" (save)="onFormSave()"
        (cancel)="onFormCancel()">
    </app-movement-form>
</p-dialog>

<!-- Modal للتفاصيل -->
<p-dialog header="تفاصيل الحركة المخزنية" [(visible)]="displayDetails" [modal]="true" [style]="{width: '500px'}"
    [draggable]="false" [resizable]="false">
    <app-movement-details *ngIf="displayDetails" [movement]="selectedMovement" (close)="displayDetails = false">
    </app-movement-details>
</p-dialog>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>