<div class="movement-container p-4 animate-fade-in" dir="rtl">
  <!-- Premium Header -->
  <div class="flex justify-content-between align-items-center mb-5">
    <div class="flex align-items-center gap-3">
      <div class="icon-circle bg-gradient-primary">
        <i class="pi pi-history text-3xl text-white"></i>
      </div>
      <div>
        <h1 class="text-4xl font-bold m-0 text-gray-800">حركات المخزون</h1>
        <p class="text-gray-500 text-sm mt-1">نظام متكامل لمراقبة وتحليل حركة المخزون</p>
      </div>
    </div>

    <div class="flex gap-2">
      <p-button icon="pi pi-filter" [rounded]="true" [outlined]="true" severity="secondary" pTooltip="الفلاتر"
        tooltipPosition="bottom" (onClick)="toggleFilters()"></p-button>
      <p-button icon="pi pi-file-pdf" [rounded]="true" [outlined]="true" severity="danger" pTooltip="تصدير PDF"
        tooltipPosition="bottom" (onClick)="exportPDF()"></p-button>
      <p-button icon="pi pi-file-excel" [rounded]="true" [outlined]="true" severity="success" pTooltip="تصدير Excel"
        tooltipPosition="bottom" (onClick)="exportExcel()"></p-button>
      <p-button icon="pi pi-refresh" [rounded]="true" severity="primary" pTooltip="تحديث" tooltipPosition="bottom"
        (onClick)="loadMovements()" [loading]="loading()"></p-button>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="grid mb-4">
    <div class="col-12 md:col-3">
      <div class="glass-panel p-4 border-round-2xl shadow-1 bg-white h-full relative overflow-hidden hover-scale">
        <div class="absolute right-0 top-0 h-full w-4px bg-emerald-500"></div>
        <div class="flex justify-content-between align-items-center">
          <div>
            <span class="text-gray-500 font-bold text-xs uppercase block mb-2">إجمالي قيمة المخزون</span>
            <h3 class="text-3xl font-bold text-emerald-600 m-0">{{ totalStockValue() | number }}</h3>
            <span class="text-xs text-gray-400">ر.ي</span>
          </div>
          <div class="bg-emerald-50 w-4rem h-4rem border-circle flex align-items-center justify-content-center">
            <i class="pi pi-wallet text-emerald-500 text-2xl"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 md:col-3">
      <div
        class="glass-panel p-4 border-round-2xl shadow-1 bg-white h-full relative overflow-hidden hover-scale cursor-pointer">
        <div class="absolute right-0 top-0 h-full w-4px bg-red-500"></div>
        <div class="flex justify-content-between align-items-center">
          <div>
            <span class="text-gray-500 font-bold text-xs uppercase block mb-2">أصناف قريبة الانتهاء</span>
            <h3 class="text-3xl font-bold text-red-600 m-0">{{ nearExpiryCount() }}</h3>
            <span class="text-xs text-gray-400">صنف</span>
          </div>
          <div class="bg-red-50 w-4rem h-4rem border-circle flex align-items-center justify-content-center relative">
            <i class="pi pi-exclamation-triangle text-red-500 text-2xl"></i>
            <span
              class="absolute top-0 right-0 bg-red-500 text-white text-xs w-1rem h-1rem border-circle flex align-items-center justify-content-center font-bold">!</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 md:col-3">
      <div class="glass-panel p-4 border-round-2xl shadow-1 bg-white h-full relative overflow-hidden hover-scale">
        <div class="absolute right-0 top-0 h-full w-4px bg-orange-500"></div>
        <div class="flex justify-content-between align-items-center">
          <div>
            <span class="text-gray-500 font-bold text-xs uppercase block mb-2">تحت حد الطلب</span>
            <h3 class="text-3xl font-bold text-orange-600 m-0">{{ lowStockCount() }}</h3>
            <span class="text-xs text-gray-400">صنف</span>
          </div>
          <div class="bg-orange-50 w-4rem h-4rem border-circle flex align-items-center justify-content-center">
            <i class="pi pi-chart-line text-orange-500 text-2xl"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 md:col-3">
      <div class="glass-panel p-4 border-round-2xl shadow-1 bg-white h-full relative overflow-hidden hover-scale">
        <div class="absolute right-0 top-0 h-full w-4px bg-indigo-500"></div>
        <div class="flex justify-content-between align-items-center">
          <div>
            <span class="text-gray-500 font-bold text-xs uppercase block mb-2">حركات اليوم</span>
            <h3 class="text-3xl font-bold text-indigo-600 m-0">{{ todayMovements() }}</h3>
            <span class="text-xs text-gray-400">عملية</span>
          </div>
          <div class="bg-indigo-50 w-4rem h-4rem border-circle flex align-items-center justify-content-center">
            <i class="pi pi-clock text-indigo-500 text-2xl"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="grid mb-4">
    <div class="col-12 md:col-8">
      <div class="glass-panel p-4 border-round-2xl shadow-2 bg-white">
        <div class="flex justify-content-between align-items-center mb-3">
          <div>
            <h3 class="text-xl font-bold text-gray-800 m-0">حركة المخزون (آخر 30 يوم)</h3>
            <p class="text-sm text-gray-500 mt-1">تحليل الإضافات والخصومات اليومية</p>
          </div>
          <i class="pi pi-chart-line text-indigo-400 text-2xl"></i>
        </div>
        <div style="height: 280px;">
          <p-chart type="line" [data]="movementTrendData" [options]="movementTrendOptions" height="280px"></p-chart>
        </div>
      </div>
    </div>

    <div class="col-12 md:col-4">
      <div class="glass-panel p-4 border-round-2xl shadow-2 bg-white h-full">
        <div class="flex justify-content-between align-items-center mb-3">
          <div>
            <h3 class="text-xl font-bold text-gray-800 m-0">توزيع المخزون</h3>
            <p class="text-sm text-gray-500 mt-1">حسب الفئات</p>
          </div>
          <i class="pi pi-chart-pie text-emerald-400 text-2xl"></i>
        </div>
        <div style="height: 280px;" class="flex align-items-center justify-content-center">
          <p-chart type="doughnut" [data]="categoryDistributionData" [options]="categoryDistributionOptions"
            height="240px"></p-chart>
        </div>
      </div>
    </div>
  </div>

  <!-- Advanced Filters (Collapsible) -->
  <div class="glass-panel p-4 mb-4 border-round-2xl shadow-1 bg-white" *ngIf="showFilters()">
    <div class="grid p-fluid">
      <div class="col-12 md:col-3">
        <label class="font-bold text-gray-700 text-sm mb-2 block">بحث</label>
        <input pInputText [(ngModel)]="query.search" placeholder="ابحث برقم المرجع أو الدواء..." class="premium-input"
          (keyup.enter)="loadMovements()">
      </div>

      <div class="col-12 md:col-3">
        <label class="font-bold text-gray-700 text-sm mb-2 block">نوع الحركة</label>
        <p-dropdown [options]="movementTypes" [(ngModel)]="query.movementType" optionLabel="label" optionValue="value"
          placeholder="جميع الأنواع" [showClear]="true" styleClass="premium-dropdown"
          (onChange)="loadMovements()"></p-dropdown>
      </div>

      <div class="col-12 md:col-3">
        <label class="font-bold text-gray-700 text-sm mb-2 block">من تاريخ</label>
        <p-calendar [(ngModel)]="startDate" [showIcon]="true" dateFormat="dd/mm/yy" placeholder="اختر التاريخ"
          inputStyleClass="premium-input" (onSelect)="onDateChange()"></p-calendar>
      </div>

      <div class="col-12 md:col-3">
        <label class="font-bold text-gray-700 text-sm mb-2 block">إلى تاريخ</label>
        <p-calendar [(ngModel)]="endDate" [showIcon]="true" dateFormat="dd/mm/yy" placeholder="اختر التاريخ"
          inputStyleClass="premium-input" (onSelect)="onDateChange()"></p-calendar>
      </div>
    </div>
  </div>

  <!-- Premium Table with Row Expansion -->
  <div class="glass-panel border-round-2xl shadow-2 bg-white overflow-hidden">
    <p-table [value]="movements()" [rows]="query.pageSize" [totalRecords]="totalRecords()" [loading]="loading()"
      [paginator]="true" [rowsPerPageOptions]="[10, 25, 50, 100]" [lazy]="true" (onLazyLoad)="onPageChange($event)"
      styleClass="p-datatable-striped p-datatable-sm" responsiveLayout="scroll" dataKey="id"
      currentPageReportTemplate="عرض {first} إلى {last} من أصل {totalRecords} حركة" [showCurrentPageReport]="true">

      <ng-template pTemplate="header">
        <tr class="bg-gray-50 text-gray-700 uppercase text-xs">
          <th style="width: 3rem" class="py-3 px-4"></th>
          <th class="py-3 px-4 font-bold border-bottom-1 border-gray-200">التاريخ</th>
          <th class="py-3 px-4 font-bold border-bottom-1 border-gray-200">نوع الحركة</th>
          <th class="py-3 px-4 font-bold border-bottom-1 border-gray-200">الدواء</th>
          <th class="py-3 px-4 font-bold border-bottom-1 border-gray-200">رقم التشغيلة</th>
          <th class="py-3 px-4 font-bold border-bottom-1 border-gray-200 text-center">الكمية</th>
          <th class="py-3 px-4 font-bold border-bottom-1 border-gray-200">المرجع</th>
          <th class="py-3 px-4 font-bold border-bottom-1 border-gray-200 text-center">إجراءات</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-movement let-expanded="expanded">
        <tr class="hover:surface-50 transition-colors">
          <td class="px-4 py-3 border-bottom-1 border-gray-100">
            <button type="button" pButton pRipple [pRowToggler]="movement"
              class="p-button-text p-button-rounded p-button-plain"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-left'"></button>
          </td>
          <td class="px-4 py-3 border-bottom-1 border-gray-100">
            <span class="font-mono text-sm text-gray-600 font-medium">
              {{ movement.date | date:'dd/MM/yyyy' }}
            </span>
            <div class="text-xs text-gray-400">{{ movement.date | date:'HH:mm' }}</div>
          </td>
          <td class="px-4 py-3 border-bottom-1 border-gray-100">
            <p-tag [value]="getMovementTypeLabel(movement.movementType)"
              [severity]="getMovementTypeSeverity(movement.movementType)" styleClass="text-xs"></p-tag>
          </td>
          <td class="px-4 py-3 border-bottom-1 border-gray-100">
            <div class="font-bold text-gray-700">{{ movement.medicineName }}</div>
            <small class="text-gray-400">كود: {{ movement.medicineId }}</small>
          </td>
          <td class="px-4 py-3 border-bottom-1 border-gray-100">
            <span class="font-mono bg-indigo-50 text-indigo-700 px-2 py-1 border-round text-sm">
              {{ movement.batchNumber || '---' }}
            </span>
          </td>
          <td class="px-4 py-3 border-bottom-1 border-gray-100 text-center">
            <span class="font-bold text-xl px-3 py-1 border-round"
              [ngClass]="isAddition(movement.movementType) ? 'text-emerald-600 bg-emerald-50' : 'text-red-600 bg-red-50'">
              {{ isAddition(movement.movementType) ? '+' : '-' }}{{ movement.quantity }}
            </span>
          </td>
          <td class="px-4 py-3 border-bottom-1 border-gray-100">
            <div class="font-semibold text-gray-700">{{ movement.referenceNumber }}</div>
            <small class="text-gray-400">{{ getReferenceTypeLabel(movement.referenceType) }}</small>
          </td>
          <td class="px-4 py-3 border-bottom-1 border-gray-100 text-center">
            <div class="flex justify-content-center gap-1">
              <p-button icon="pi pi-eye" [rounded]="true" [text]="true" severity="info" size="small"
                pTooltip="عرض التفاصيل" tooltipPosition="top" (onClick)="viewDetails(movement)"></p-button>
              <p-button icon="pi pi-print" [rounded]="true" [text]="true" severity="secondary" size="small"
                pTooltip="طباعة" tooltipPosition="top"></p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="rowexpansion" let-movement>
        <tr>
          <td colspan="8" class="p-0">
            <div class="p-4 bg-gray-50">
              <div class="grid">
                <div class="col-12 md:col-6">
                  <div class="bg-white p-3 border-round-xl shadow-1">
                    <h4 class="text-sm font-bold text-gray-600 uppercase mb-3 flex align-items-center gap-2">
                      <i class="pi pi-info-circle text-indigo-500"></i>
                      معلومات إضافية
                    </h4>
                    <div class="grid text-sm">
                      <div class="col-6 text-gray-500">المستخدم:</div>
                      <div class="col-6 font-bold text-gray-800">{{ movement.createdByName || 'غير محدد' }}</div>
                      <div class="col-6 text-gray-500">الملاحظات:</div>
                      <div class="col-6 text-gray-700">{{ movement.notes || 'لا توجد ملاحظات' }}</div>
                    </div>
                  </div>
                </div>
                <div class="col-12 md:col-6">
                  <div class="bg-white p-3 border-round-xl shadow-1">
                    <h4 class="text-sm font-bold text-gray-600 uppercase mb-3 flex align-items-center gap-2">
                      <i class="pi pi-box text-emerald-500"></i>
                      تفاصيل التشغيلة
                    </h4>
                    <div class="grid text-sm">
                      <div class="col-6 text-gray-500">رقم التشغيلة:</div>
                      <div class="col-6 font-bold text-indigo-600">{{ movement.batchNumber || 'غير محدد' }}</div>
                      <div class="col-6 text-gray-500">معرف التشغيلة:</div>
                      <div class="col-6 font-mono text-gray-700">{{ movement.batchId || 'N/A' }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center p-6">
            <div class="flex flex-column align-items-center">
              <div class="w-5rem h-5rem bg-gray-50 border-circle flex align-items-center justify-content-center mb-3">
                <i class="pi pi-inbox text-4xl text-gray-300"></i>
              </div>
              <span class="text-gray-500 font-medium text-lg">لا توجد حركات مخزنية</span>
              <span class="text-gray-400 text-sm mt-1">جرب تغيير الفلاتر أو إضافة حركات جديدة</span>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<p-toast position="top-left"></p-toast>