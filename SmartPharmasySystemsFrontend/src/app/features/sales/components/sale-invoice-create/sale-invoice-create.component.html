<div class="card p-0 shadow-3 border-round-xl overflow-hidden" [class.opacity-80]="loading" dir="rtl">
    <!-- Header Section -->
    <div class="bg-primary p-4 text-white flex justify-content-between align-items-center">
        <div class="flex align-items-center gap-3">
            <i class="pi pi-file-edit text-3xl"></i>
            <div>
                <h2 class="m-0 text-xl font-bold">فاتورة مبيعات</h2>
                <small class="opacity-80">إدارة مبيعات الصيدلية والتحكم في المخزون</small>
            </div>
        </div>
        <div class="flex align-items-center gap-3">
            <p-tag [severity]="getStatusSeverity(saleForm.get('status')?.value)"
                [value]="getStatusLabel(saleForm.get('status')?.value)" styleClass="text-lg px-3 py-2"></p-tag>
            <div class="flex gap-2">
                <p-button *ngIf="saleForm.get('status')?.value === 'Draft'" label="حفظ كمسودة" icon="pi pi-save"
                    severity="info" (onClick)="saveDraft()" [loading]="loading"></p-button>
                <p-button *ngIf="saleForm.get('status')?.value === 'Draft'" label="اعتماد الفاتورة" icon="pi pi-check"
                    severity="success" (onClick)="approveInvoice()" [loading]="loading"
                    [disabled]="saleForm.invalid || !currentInvoice"></p-button>
                <p-button *ngIf="saleForm.get('status')?.value === 'Approved'" label="إلغاء الفاتورة" icon="pi pi-times"
                    severity="danger" (onClick)="cancelInvoice()" [loading]="loading"></p-button>
                <p-button label="رجوع" icon="pi pi-arrow-left" severity="secondary" outlined
                    (onClick)="cancel()"></p-button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <form [formGroup]="saleForm" class="p-4 bg-gray-50">
        <!-- Invoice Header Row -->
        <div class="grid p-fluid">
            <div class="col-12 md:col-2">
                <label class="block font-bold mb-2 text-secondary">رقم الفاتورة</label>
                <input pInputText formControlName="invoiceNumber" placeholder="تلقائي..."
                    class="bg-gray-100 font-bold" />
            </div>
            <div class="col-12 md:col-3">
                <label class="block font-bold mb-2 text-secondary">العميل</label>
                <input pInputText formControlName="customerName" placeholder="اسم العميل..." />
            </div>
            <div class="col-12 md:col-3">
                <label class="block font-bold mb-2 text-secondary">تاريخ الفاتورة</label>
                <p-calendar formControlName="saleInvoiceDate" [showIcon]="true" dateFormat="dd/mm/yy"
                    appendTo="body"></p-calendar>
            </div>
            <div class="col-12 md:col-2">
                <label class="block font-bold mb-2 text-secondary">طريقة الدفع</label>
                <p-dropdown [options]="paymentMethods" formControlName="paymentMethod" appendTo="body"></p-dropdown>
            </div>
            <div class="col-12 md:col-2">
                <label class="block font-bold mb-2 text-secondary">الملاحظات</label>
                <input pInputText formControlName="notes" placeholder="..." />
            </div>
        </div>

        <p-divider align="right" styleClass="my-5">
            <span class="flex align-items-center gap-2 text-primary font-bold">
                <i class="pi pi-list"></i> تفاصيل الأصناف
            </span>
        </p-divider>

        <!-- Details Grid -->
        <p-table [value]="items.controls" responsiveLayout="scroll"
            styleClass="p-datatable-gridlines p-datatable-sm shadow-1">
            <ng-template pTemplate="header">
                <tr>
                    <th class="bg-white text-right p-3" style="min-width: 250px">الصنف</th>
                    <th class="bg-white text-center p-3" style="width: 200px">الدفعة</th>
                    <th class="bg-white text-center p-3" style="width: 120px">الكمية</th>
                    <th class="bg-white text-center p-3" style="width: 150px">سعر الوحدة</th>
                    <th class="bg-white text-center p-3" style="width: 150px">الإجمالي</th>
                    <th *ngIf="!isReadOnly" class="bg-white text-center p-3" style="width: 50px"></th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item let-i="rowIndex">
                <tr [formGroup]="$any(item)" class="bg-white">
                    <td class="p-2">
                        <p-autoComplete *ngIf="!isReadOnly; else medicineNameRead" [suggestions]="filteredMedicines"
                            (completeMethod)="searchMedicine($event)" field="name"
                            (onSelect)="onMedicineSelect($event.value, i)" placeholder="ابحث..." styleClass="w-full"
                            appendTo="body" [forceSelection]="true"></p-autoComplete>
                        <ng-template #medicineNameRead>
                            <span class="font-bold">{{item.get('medicineName')?.value}}</span>
                        </ng-template>
                    </td>
                    <td class="p-2">
                        <p-dropdown *ngIf="!isReadOnly; else batchRead" [options]="batchesByItem[i] || []"
                            optionLabel="companyBatchNumber" placeholder="اختر الدفعة" appendTo="body"
                            formControlName="batchId" optionValue="id" styleClass="w-full border-none">
                            <ng-template pTemplate="item" let-batch>
                                <div class="flex justify-content-between align-items-center w-full">
                                    <span class="font-bold text-primary">{{batch.companyBatchNumber}}</span>
                                    <p-tag [severity]="batch.remainingQuantity < 10 ? 'danger' : 'success'"
                                        [value]="batch.remainingQuantity + ' متوفر'"></p-tag>
                                </div>
                            </ng-template>
                        </p-dropdown>
                        <ng-template #batchRead>
                            <div class="text-center font-medium">{{item.get('batchId')?.value}}</div>
                        </ng-template>
                    </td>
                    <td class="p-2">
                        <p-inputNumber formControlName="quantity" [min]="1" styleClass="w-full"
                            inputStyleClass="text-center font-bold" [disabled]="isReadOnly"></p-inputNumber>
                    </td>
                    <td class="p-2">
                        <p-inputNumber formControlName="salePrice" mode="currency" currency="EGP" styleClass="w-full"
                            inputStyleClass="text-center" [disabled]="isReadOnly"></p-inputNumber>
                    </td>
                    <td class="p-2 text-center font-bold text-primary">
                        {{item.get('totalSale')?.value | currency:'EGP'}}
                    </td>
                    <td *ngIf="!isReadOnly" class="p-2 text-center">
                        <button pButton icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-text"
                            (click)="removeItem(i)"></button>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="footer" *ngIf="!isReadOnly">
                <tr>
                    <td colspan="6" class="p-3 text-right">
                        <p-button label="إضافة صنف" icon="pi pi-plus" severity="info" outlined size="small"
                            (onClick)="addItem()"></p-button>
                    </td>
                </tr>
            </ng-template>
        </p-table>

        <!-- Summary Panel -->
        <div class="grid mt-5 justify-content-end">
            <div class="col-12 md:col-4">
                <div class="bg-white border-round-xl shadow-1 p-4 border-1 border-primary-100">
                    <div class="flex justify-content-between py-2 border-bottom-1 border-gray-100">
                        <span class="text-secondary">إجمالي المبلغ:</span>
                        <span class="text-xl font-bold">{{currentInvoice?.totalAmount || 0 | currency:'EGP'}}</span>
                    </div>
                    <div class="flex justify-content-between py-2 border-bottom-1 border-gray-100">
                        <span class="text-secondary">إجمالي التكلفة:</span>
                        <span class="text-xl font-bold">{{currentInvoice?.totalCost || 0 | currency:'EGP'}}</span>
                    </div>
                    <div class="flex justify-content-between py-2 bg-primary-50 px-2 mt-3 border-round">
                        <span class="text-primary font-bold">إجمالي الربح:</span>
                        <span class="text-2xl font-extrabold text-primary">{{currentInvoice?.totalProfit || 0 |
                            currency:'EGP'}}</span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>