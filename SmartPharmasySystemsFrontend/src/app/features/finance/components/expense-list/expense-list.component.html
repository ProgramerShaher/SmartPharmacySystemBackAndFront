<div class="expense-list-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <p-progressSpinner></p-progressSpinner>
    <p class="loading-text">جاري تحميل المصروفات...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading" class="card">
    <div class="card-header">
      <h5>إدارة المصروفات</h5>
      <div class="header-actions">
        <p-button
          label="إضافة مصروف جديد"
          icon="pi pi-plus"
          [outlined]="true"
          severity="success"
          (onClick)="addNewExpense()"
          pTooltip="إضافة مصروف جديد"
          tooltipPosition="bottom"
        ></p-button>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
      <div class="p-field">
        <label for="search">البحث في المصروفات</label>
        <input
          id="search"
          pInputText
          [(ngModel)]="searchTerm"
          placeholder="ابحث في نوع المصروف أو الملاحظات..."
          (input)="onSearch()"
          class="search-input"
        />
      </div>
      <div class="p-field">
        <label for="expenseTypeFilter">تصفية حسب النوع</label>
        <p-dropdown
          id="expenseTypeFilter"
          [options]="expenseTypeOptions"
          [(ngModel)]="expenseTypeFilter"
          optionLabel="label"
          optionValue="value"
          placeholder="اختر نوع المصروف"
          (onChange)="onExpenseTypeFilterChange()"
          class="expense-type-filter"
        ></p-dropdown>
      </div>
      <div class="p-field date-range-field">
        <label>الفترة الزمنية</label>
        <div class="date-range-inputs">
          <p-calendar
            [(ngModel)]="startDate"
            [maxDate]="endDate || undefined"
            placeholder="من تاريخ"
            dateFormat="dd/mm/yy"
            (onSelect)="onDateRangeChange()"
            class="date-input"
          ></p-calendar>
          <span class="date-separator">-</span>
          <p-calendar
            [(ngModel)]="endDate"
            [minDate]="startDate || undefined"
            placeholder="إلى تاريخ"
            dateFormat="dd/mm/yy"
            (onSelect)="onDateRangeChange()"
            class="date-input"
          ></p-calendar>
        </div>
      </div>
    </div>

    <!-- Table -->
    <p-table
      [value]="expenses"
      [paginator]="true"
      [rows]="pageSize"
      [totalRecords]="totalRecords"
      [loading]="loading"
      [responsive]="true"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="عرض {first} إلى {last} من أصل {totalRecords} مصروف"
      [rowsPerPageOptions]="[5, 10, 25, 50]"
      sortMode="multiple"
      class="expenses-table"
      (onPage)="onPageChange($event)"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="expenseType" class="expense-type-column">
            نوع المصروف
            <p-sortIcon field="expenseType"></p-sortIcon>
          </th>
          <th pSortableColumn="amount" class="amount-column">
            المبلغ
            <p-sortIcon field="amount"></p-sortIcon>
          </th>
          <th pSortableColumn="expenseDate" class="date-column">
            التاريخ
            <p-sortIcon field="expenseDate"></p-sortIcon>
          </th>
          <th pSortableColumn="paymentMethod" class="payment-method-column">
            طريقة الدفع
            <p-sortIcon field="paymentMethod"></p-sortIcon>
          </th>
          <th class="notes-column">الملاحظات</th>
          <th class="actions-column">الإجراءات</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-expense>
        <tr>
          <td class="expense-type-cell">
            <div class="expense-type-content">
              <i class="pi pi-money-bill expense-icon"></i>
              <span class="expense-type-text">{{ expense.expenseType }}</span>
            </div>
          </td>
          <td class="amount-cell">
            <span class="amount-value">{{ expense.amount | currency:'EGP':'symbol':'1.2-2':'ar' }}</span>
          </td>
          <td>
            <span class="expense-date">{{ expense.expenseDate | date:'dd/MM/yyyy' }}</span>
          </td>
          <td>
            <p-tag
              [value]="getPaymentMethodLabel(expense.paymentMethod)"
              [severity]="getPaymentMethodSeverity(expense.paymentMethod)"
              class="payment-method-tag"
            ></p-tag>
          </td>
          <td class="notes-cell">
            <span class="notes-text" [title]="expense.notes">
              {{ expense.notes || 'لا توجد ملاحظات' }}
            </span>
          </td>
          <td class="actions-cell">
            <div class="action-buttons">
              <!-- View Details Button -->
              <p-button
                icon="pi pi-eye"
                [outlined]="true"
                severity="info"
                size="small"
                pTooltip="عرض التفاصيل"
                tooltipPosition="top"
                (onClick)="viewDetails(expense)"
                ariaLabel="عرض تفاصيل المصروف"
              ></p-button>

              <!-- Edit Button -->
              <p-button
                icon="pi pi-pencil"
                [outlined]="true"
                severity="warning"
                size="small"
                pTooltip="تعديل المصروف"
                tooltipPosition="top"
                (onClick)="editExpense(expense)"
                ariaLabel="تعديل المصروف"
              ></p-button>

              <!-- Delete Button -->
              <p-button
                icon="pi pi-trash"
                [outlined]="true"
                severity="danger"
                size="small"
                pTooltip="حذف المصروف"
                tooltipPosition="top"
                (onClick)="deleteExpense($event, expense)"
                ariaLabel="حذف المصروف"
              ></p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Empty State Template -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center py-4">
            <i class="pi pi-money-bill text-4xl text-gray-400 mb-3 block"></i>
            <span class="text-gray-500 text-lg">لا توجد مصروفات</span>
            <p class="text-gray-400 mt-2">ابدأ بإضافة مصروف جديد</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
