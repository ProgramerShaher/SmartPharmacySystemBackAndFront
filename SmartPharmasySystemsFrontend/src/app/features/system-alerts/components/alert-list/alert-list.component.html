<div class="block">
  <!-- Header -->
  <div class="page-header">
    <div class="title-section">
      <h2><i class="pi pi-table"></i> إدارة التنبيهات المركزية</h2>
    </div>
      <div class="flex gap-2">
        <p-button label="فحص الصلاحية" icon="pi pi-sync" styleClass="p-button-warning p-button-sm"
          (onClick)="generateExpiryAlerts()"></p-button>
        <p-button label="تنبيه جديد" icon="pi pi-plus" styleClass="p-button-primary p-button-sm"
          (onClick)="createAlert()"></p-button>
      </div>
  </div>

  <!-- Structured Control Panel -->
  <div class="control-panel">
    <span class="panel-title">أدوات الفرز والبحث</span>
    <div class="filters-grid">
      <div class="filter-item">
        <label class="filter-label">البحث الشامل</label>
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
                <input type="text" pInputText placeholder="ابحث هنا..." [(ngModel)]="searchTerm" (input)="onSearch()" />
                </span>
                </div>
        <div class="filter-item">
          <label class="filter-label">حالة التنبيه</label>
          <p-dropdown [options]="statusOptions" [(ngModel)]="statusFilter" (onChange)="onStatusFilterChange()"
                placeholder="-- اختر الحالة --" [showClear]="true"></p-dropdown>
        </div>
        <div class="filter-item">
          <label class="filter-label">رقم الدفعة (Batch)</label>
          <input type="text" pInputText placeholder="مثال: BN-2024" [(ngModel)]="batchNumberFilter" (input)="onSearch()" />
        </div>
        <div class="filter-item">
          <label class="filter-label">اسم الدواء</label>
          <input type="text" pInputText placeholder="اسم المنتج..." [(ngModel)]="medicineNameFilter" (input)="onSearch()" />
        </div>
    </div>
  </div>

  <!-- Structured Grid Table -->
  <div class="table-wrapper">
    <p-table [value]="alerts" [rows]="10" [paginator]="true" [rowHover]="true"
      styleClass="p-datatable-sm p-datatable-gridlines p-datatable-striped" responsiveLayout="scroll">
        <ng-template pTemplate="header">
            <tr>
              <th style="width: 5%">ID</th>
              <th style="width: 5%; text-align: center">نوع</th>
              <th style="width: 15%">تصنيف</th>
              <th style="width: 25%">نص التنبيه</th>
              <th style="width: 15%">المرجع</th>
              <th style="width: 10%">تاريخ التنبيه</th>
              <th style="width: 10%">تاريخ الانتهاء</th>
              <th style="width: 8%">الحالة</th>
              <th style="width: 7%; text-align: center">خيارات</th>
            </tr>
            </ng-template>

        <ng-template pTemplate="body" let-alert>
            <tr>
              <td class="font-bold text-center">{{ alert.id }}</td>
            
              <td class="text-center">
                <div class="icon-box" [ngClass]="{
                                    'bg-red': getAlertTypeSeverity(alert.alertType) === 'danger',
                                    'bg-orange': getAlertTypeSeverity(alert.alertType) === 'warning',
                                    'bg-blue': getAlertTypeSeverity(alert.alertType) === 'info',
                                    'bg-green': getAlertTypeSeverity(alert.alertType) === 'success'
                                }">
                  <i [class]="getAlertTypeIcon(alert.alertType)"></i>
                </div>
              </td>

                <td>
                    <span class="type-text">{{ getAlertTypeLabel(alert.alertType) }}</span>
                    </td>

                <td>
                    <div class="msg-text" pTooltip="{{ alert.message }}">{{ alert.message }}</div>
                    </td>

                <td>
                    <span class="ref-text" *ngIf="alert.medicineName">{{ alert.medicineName }}</span>
                    <span class="batch-tag" *ngIf="alert.batchNumber">BN:{{ alert.batchNumber }}</span>
                    <span *ngIf="!alert.medicineName" class="text-400">--</span>
                    </td>

                <td>
                    <span class="date-mono">{{ alert.executionDate | date:'yyyy-MM-dd' }}</span>
                    </td>

                <td>
                  <span class="date-mono" [class.text-danger]="isExpired(alert.expiryDate)" *ngIf="alert.expiryDate">
                    {{ alert.expiryDate | date:'yyyy-MM-dd' }}
                  </span>
                  <span *ngIf="!alert.expiryDate" class="text-400">--</span>
                </td>

                <td>
                  <p-tag [value]="getStatusLabel(alert.status)" [severity]="getStatusSeverity(alert.status)"></p-tag>
                </td>

                <td class="text-center">
                  <div class="btn-group">
                    <button pButton icon="pi pi-eye" class="p-button-outlined p-button-secondary action-sq" (click)="viewDetails(alert)"
                      pTooltip="عرض"></button>
                    <button pButton icon="pi pi-pencil" class="p-button-outlined p-button-primary action-sq" *ngIf="alert.status === 0"
                      (click)="editAlert(alert)" pTooltip="تعديل"></button>
                    <button pButton icon="pi pi-trash" class="p-button-outlined p-button-danger action-sq"
                      (click)="deleteAlert($event, alert)" pTooltip="حذف"></button>
                  </div>
                </td>
                </tr>
                </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
                <td colspan="9" class="text-center p-4">
                  لاتوجد بيانات
                </td>
                </tr>
                </ng-template>
    </p-table>
  </div>
</div>
<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>