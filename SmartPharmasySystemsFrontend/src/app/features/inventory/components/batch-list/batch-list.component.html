<div class="list-container">
    <h2>Batches</h2>
    <div class="card p-4 shadow-2 border-round-xl" dir="rtl">
        <div class="flex flex-column md:flex-row md:align-items-center justify-content-between mb-4 gap-3">
            <div class="flex align-items-center gap-3">
                <div
                    class="w-3rem h-3rem border-circle bg-primary-reverse flex align-items-center justify-content-center">
                    <i class="pi pi-box text-primary text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold m-0 text-primary">إدارة دفعات الأدوية</h2>
                    <small class="text-secondary">متابعة المخزون، تواريخ الصلاحية، وحركات الدفعات</small>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="grid mb-4 p-fluid">
            <div class="col-12 md:col-4">
                <span class="p-input-icon-left w-full">
                    <i class="pi pi-search"></i>
                    <input pInputText type="text" [(ngModel)]="searchTerm" (input)="applyFilters()"
                        placeholder="ابحث بالاسم، الكود، أو الباركود..." class="border-round-xl" />
                </span>
            </div>
            <div class="col-12 md:col-3">
                <p-dropdown [options]="sellableOptions" [(ngModel)]="sellableFilter" (onChange)="applyFilters()"
                    placeholder="حالة البيع" styleClass="border-round-xl"></p-dropdown>
            </div>
            <div class="col-12 md:col-3">
                <p-dropdown [options]="expiryOptions" [(ngModel)]="expiryFilter" (onChange)="applyFilters()"
                    placeholder="الصلاحية" styleClass="border-round-xl"></p-dropdown>
            </div>
            <div class="col-12 md:col-2">
                <button pButton label="إعادة تعيين" icon="pi pi-refresh" class="p-button-outlined border-round-xl"
                    (click)="searchTerm=''; sellableFilter=null; expiryFilter='all'; applyFilters()"></button>
            </div>
        </div>

        <p-table [value]="filteredBatches" [loading]="loading" [paginator]="true" [rows]="10" responsiveLayout="scroll"
            styleClass="p-datatable-sm p-datatable-gridlines border-round-xl overflow-hidden shadow-1">
            <ng-template pTemplate="header">
                <tr>
                    <th class="bg-gray-50 font-bold">الدواء</th>
                    <th class="bg-gray-50 font-bold text-center">رقم الدفعة</th>
                    <th class="bg-gray-50 font-bold text-center">الباركود</th>
                    <th class="bg-gray-50 font-bold text-center">الكمية الكلية</th>
                    <th class="bg-gray-50 font-bold text-center">المتبقي</th>
                    <th class="bg-gray-50 font-bold text-center">المباع</th>
                    <th class="bg-gray-50 font-bold text-center">تاريخ الانتهاء</th>
                    <th class="bg-gray-50 font-bold text-center">الحالة</th>
                    <th class="bg-gray-50 font-bold text-center">الإجراءات</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-batch>
                <tr [class.bg-red-50]="batch.daysUntilExpiry <= 0"
                    [class.bg-orange-50]="batch.daysUntilExpiry > 0 && batch.daysUntilExpiry <= 30">
                    <td>
                        <div class="font-bold text-blue-800">{{ batch.medicineName }}</div>
                        <small class="text-secondary"><i class="pi pi-map-marker mr-1"></i> {{ batch.storageLocation ||
                            'غير محدد' }}</small>
                    </td>
                    <td class="text-center font-mono text-sm">{{ batch.companyBatchNumber }}</td>
                    <td class="text-center font-mono text-sm">{{ batch.batchBarcode }}</td>
                    <td class="text-center">{{ batch.quantity }}</td>
                    <td class="text-center">
                        <span class="font-bold" [class.text-red-600]="batch.remainingQuantity === 0"
                            [class.text-green-600]="batch.remainingQuantity > 0">
                            {{ batch.remainingQuantity }}
                        </span>
                    </td>
                    <td class="text-center">{{ batch.soldQuantity }}</td>
                    <td class="text-center">
                        <p-tag [severity]="getExpirySeverity(batch.daysUntilExpiry)"
                            [value]="getExpiryLabel(batch.daysUntilExpiry)" [rounded]="true" styleClass="px-3"></p-tag>
                        <div class="mt-1 text-xs text-secondary">{{ batch.expiryDate | date:'dd/MM/yyyy' }}</div>
                    </td>
                    <td class="text-center">
                        <p-tag [severity]="batch.isSellable ? 'success' : 'danger'"
                            [value]="batch.isSellable ? 'للبيع' : 'موقف'" [rounded]="true"></p-tag>
                    </td>
                    <td class="text-center">
                        <div class="flex justify-content-center gap-2">
                            <button pButton icon="pi pi-eye" class="p-button-rounded p-button-info p-button-text"
                                pTooltip="عرض التفاصيل والسجل" (click)="viewBatch(batch.id)"></button>
                            <button pButton icon="pi pi-exclamation-triangle"
                                class="p-button-rounded p-button-warning p-button-text" pTooltip="تسجيل تلف أو تعديل"
                                (click)="showAction(batch)"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="9" class="text-center p-5 text-secondary">
                        <i class="pi pi-info-circle text-4xl mb-3 block"></i>
                        لا توجد دفعات مطابقة لمعايير البحث.
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<app-batch-actions-dialog *ngIf="displayActionDialog" [visible]="displayActionDialog" [batch]="selectedBatch"
    (onClose)="displayActionDialog = false" (onSuccess)="onActionSuccess()">
</app-batch-actions-dialog>