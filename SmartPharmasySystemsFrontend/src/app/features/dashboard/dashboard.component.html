<div class="ultimate-dashboard" dir="rtl">
    <p-toast position="top-center"></p-toast>

    <!-- ============================================
       رأس الصفحة / Page Header
       ============================================ -->
    <div class="dashboard-header flex justify-content-between align-items-center mb-4">
        <div>
    <h1 class="text-4xl font-bold text-color m-0 mb-2 gradient-text">
        <i class="pi pi-chart-line ml-2"></i>
        مركز القيادة التحليلي
    </h1>
    <p class="text-color-secondary m-0 text-lg">لوحة التحكم الشاملة - تحديث تلقائي كل 30 ثانية</p>
    </div>
    <div class="flex gap-2">
        <button pButton icon="pi pi-refresh" label="تحديث" class="p-button-outlined p-button-rounded"
            (click)="refreshDashboard()" [loading]="isLoading()"></button>
        <button pButton icon="pi pi-cog" class="p-button-outlined p-button-rounded p-button-secondary" pTooltip="الإعدادات"
            tooltipPosition="bottom"></button>
    </div>
    </div>
<!-- ============================================
       بطاقات المؤشرات الرئيسية / KPI Cards
       ============================================ -->
<div class="grid mb-4">
    <!-- رصيد الصيدلية / Pharmacy Balance -->
    <div class="col-12 md:col-6 lg:col-3">
        <app-stat-card *ngIf="!isLoading(); else skeleton" title="الرصيد النقدي الحالي" [value]="pharmacyBalance()"
            icon="pi-wallet" [trend]="salesTrend()" subtitle="رصيد الصيدلية" color="emerald"
            format="currency"></app-stat-card>
        <ng-template #skeleton>
            <p-skeleton height="160px" borderRadius="16px"></p-skeleton>
        </ng-template>
    </div>
<!-- مبيعات اليوم / Today's Sales -->
<div class="col-12 md:col-6 lg:col-3">
    <app-stat-card *ngIf="!isLoading()" title="مبيعات اليوم" [value]="todaySales()" icon="pi-shopping-cart"
        subtitle="إجمالي المبيعات" color="blue" format="currency"></app-stat-card>
    </div>
<!-- أصناف قريبة من الانتهاء / Expiring Items -->
<div class="col-12 md:col-6 lg:col-3">
    <app-stat-card *ngIf="!isLoading()" title="أصناف قريبة الانتهاء" [value]="expiringItems()" icon="pi-calendar-times"
        subtitle="خلال 30 يوم" color="orange" format="number"></app-stat-card>
</div>

<!-- أصناف منخفضة المخزون / Low Stock Items -->
<div class="col-12 md:col-6 lg:col-3">
    <app-stat-card *ngIf="!isLoading()" title="أصناف منخفضة المخزون" [value]="lowStockItems()"
        icon="pi-exclamation-triangle" subtitle="تحتاج إعادة طلب" color="red" format="number"></app-stat-card>
</div>
</div>

<!-- ============================================
       الرسوم البيانية الرئيسية / Main Charts
       ============================================ -->
<div class="grid mb-4">
    <!-- مخطط المبيعات مقابل المشتريات (6 أشهر) / Sales vs Purchases Chart -->
    <div class="col-12 lg:col-8">
        <div class="analytics-card">
            <div class="flex justify-content-between align-items-center mb-4">
                <div>
            <h3 class="text-2xl font-bold text-color m-0 mb-1">
                <i class="pi pi-chart-line ml-2 text-emerald-500"></i>
                تحليل المبيعات مقابل المشتريات
            </h3>
            <p class="text-color-secondary text-sm m-0">اتجاه آخر 6 أشهر</p>
            </div>
        <p-tag value="مباشر" severity="success" icon="pi pi-circle-fill"></p-tag>
        </div>
        <div *ngIf="!isLoading() && salesVsPurchasesData; else chartSkeleton" style="height: 400px;">
            <p-chart type="line" [data]="salesVsPurchasesData" [options]="salesVsPurchasesOptions"
                [style]="{'height': '100%'}"></p-chart>
        </div>
<ng-template #chartSkeleton>
    <p-skeleton height="400px"></p-skeleton>
</ng-template>
</div>
    </div>
<!-- مخطط توزيع المخزون / Inventory Distribution Chart -->
<div class="col-12 lg:col-4">
    <div class="analytics-card">
        <div class="mb-4">
            <h3 class="text-xl font-bold text-color m-0 mb-1">
                <i class="pi pi-box ml-2 text-blue-500"></i>
                توزيع المخزون
            </h3>
            <p class="text-color-secondary text-sm m-0">حسب الفئة</p>
        </div>

        <div *ngIf="!isLoading() && inventoryDistributionData" style="height: 350px;">
            <p-chart type="doughnut" [data]="inventoryDistributionData" [options]="inventoryDistributionOptions"
                [style]="{'height': '100%'}"></p-chart>
        </div>
    </div>
</div>
</div>

<!-- ============================================
       خريطة العمليات والتنبيهات / Operations Heatmap & Alerts
       ============================================ -->
<div class="grid mb-4">
    <!-- أفضل 5 أدوية مبيعاً / Top 5 Best-Selling Medicines -->
    <div class="col-12 lg:col-7">
        <div class="analytics-card">
            <div class="flex justify-content-between align-items-center mb-4">
                <div>
            <h3 class="text-xl font-bold text-color m-0 mb-1">
                <i class="pi pi-star-fill ml-2 text-yellow-500"></i>
                أفضل الأدوية مبيعاً
            </h3>
            <p class="text-color-secondary text-sm m-0">أعلى 5 أصناف هذا الشهر</p>
            </div>
        </div>
<p-table [value]="topSellingMedicines()" [tableStyle]="{'min-width': '100%'}" styleClass="p-datatable-sm">
    <ng-template pTemplate="header">
        <tr>
            <th class="text-right">اسم الدواء</th>
            <th class="text-center">الكمية المباعة</th>
            <th class="text-center">الدفعات المتبقية</th>
            <th class="text-right">الإيرادات</th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-medicine let-rowIndex="rowIndex">
        <tr class="hover-row">
            <td>
                <div class="flex align-items-center gap-2">
                    <span class="rank-badge">{{ rowIndex + 1 }}</span>
                    <span class="font-semibold">{{ medicine.name }}</span>
                </div>
            </td>
            <td class="text-center">
                <p-tag [value]="medicine.soldQuantity" severity="success" [rounded]="true"></p-tag>
            </td>
            <td class="text-center">
                <span class="batch-indicator" [class.low-batches]="medicine.remainingBatches < 5">
                    {{ medicine.remainingBatches }} دفعات
                </span>
            </td>
            <td class="text-right">
                <span class="revenue-text">{{ medicine.revenue | number:'1.0-0' }} ريال</span>
            </td>
            </tr>
            </ng-template>
            </p-table>
            </div>
    </div>
<!-- مخطط زمني للتنبيهات / Alert Timeline -->
<div class="col-12 lg:col-5">
    <div class="analytics-card">
        <div class="flex justify-content-between align-items-center mb-4">
            <div>
            <h3 class="text-xl font-bold text-color m-0 mb-1">
                <i class="pi pi-bell ml-2 text-orange-500"></i>
                التنبيهات الحديثة
            </h3>
            <p class="text-color-secondary text-sm m-0">آخر التحديثات</p>
            </div>
            <button pButton icon="pi pi-arrow-left" label="عرض الكل" class="p-button-text p-button-sm"
                [routerLink]="['/system-alerts']"></button>
            </div>
            
            <div class="alerts-timeline">
                <div *ngFor="let alert of recentAlerts()" class="alert-timeline-item" [class]="'alert-' + alert.type">
                    <div class="alert-icon-container" [style.background-color]="alert.color + '20'">
                        <i [class]="'pi ' + alert.icon" [style.color]="alert.color"></i>
                    </div>
                    <div class="alert-content">
                        <h4 class="alert-title">{{ alert.title }}</h4>
                        <p class="alert-message">{{ alert.message }}</p>
                        <span class="alert-time">{{ alert.time }}</span>
                    </div>
                </div>
        </div>
        </div>
    </div>
    </div>

<!-- ============================================
       لوحة الإجراءات السريعة / Quick Actions Panel
       ============================================ -->
<div class="grid">
    <div class="col-12">
        <div class="quick-actions-panel">
            <h3 class="text-xl font-bold text-color mb-3">
                <i class="pi pi-bolt ml-2"></i>
                إجراءات سريعة
            </h3>

            <div class="grid">
                <div class="col-12 md:col-6 lg:col-3">
                    <button pButton label="فاتورة بيع جديدة" icon="pi pi-plus"
                        class="p-button-success w-full quick-action-btn" (click)="navigateToNewSale()">
                        <span class="p-button-label">فاتورة بيع جديدة</span>
                    </button>
                </div>
                <div class="col-12 md:col-6 lg:col-3">
                    <button pButton label="فاتورة شراء جديدة" icon="pi pi-shopping-bag"
                        class="p-button-primary w-full quick-action-btn" (click)="navigateToNewPurchase()">
                        <span class="p-button-label">فاتورة شراء جديدة</span>
                    </button>
                </div>
                <div class="col-12 md:col-6 lg:col-3">
                    <button pButton label="التقارير المالية" icon="pi pi-chart-bar"
                        class="p-button-info w-full quick-action-btn" (click)="navigateToFinancial()">
                        <span class="p-button-label">التقارير المالية</span>
                    </button>
                </div>
                <div class="col-12 md:col-6 lg:col-3">
                    <button pButton label="إدارة المخزون" icon="pi pi-box"
                        class="p-button-warning w-full quick-action-btn" (click)="navigateToInventory()">
                        <span class="p-button-label">إدارة المخزون</span>
                    </button>
                </div>
        </div>
    </div>
    </div>
    </div>
</div>