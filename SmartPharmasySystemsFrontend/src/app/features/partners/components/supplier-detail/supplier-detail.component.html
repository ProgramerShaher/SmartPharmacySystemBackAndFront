<!-- supplier-detail.component.html مع إضافة قسم الفواتير والمرتجعات -->
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header Card -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-6 mb-6 shadow-xl">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="flex items-center gap-4">
                    <button aria-label="رجوع" pButton pRipple icon="pi pi-arrow-right"
                        class="p-button-rounded p-button-text bg-white/10 hover:bg-white/20 text-white"
                        (click)="goBack()" pTooltip="رجوع للقائمة" tooltipPosition="right"></button>
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <i class="pi pi-verified text-blue-200"></i>
                            <span class="text-blue-100 font-medium text-sm">ملف المورد المعتمد</span>
                        </div>
                        <h1 class="text-3xl md:text-4xl font-bold text-white mb-1">
                            {{ supplier?.name || 'جاري التحميل...' }}
                        </h1>
                        <p class="text-blue-100 text-sm" *ngIf="supplier">
                            رقم المورد: #SUP-{{ supplier.id }}
                        </p>
                    </div>
                </div>

                <div class="flex gap-2" *ngIf="supplier">
                    <button aria-label="edit" pButton pRipple label="تعديل البيانات" icon="pi pi-pencil"
                        class="p-button-warning bg-amber-500 border-amber-500" (click)="editSupplier()"
                        pTooltip="تعديل بيانات المورد" tooltipPosition="left"></button>
                    <button aria-label="edit" pButton pRipple label="حذف المورد" icon="pi pi-trash"
                        class="p-button-outlined p-button-danger border-white/30 text-white"
                        (click)="deleteSupplier($event)" pTooltip="حذف المورد نهائياً" tooltipPosition="left"></button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="loading" class="flex justify-center items-center min-h-[400px]">
            <div class="text-center">
                <div
                    class="w-20 h-20 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4">
                </div>
                <p class="text-gray-600 font-medium text-lg">جاري تحميل تفاصيل المورد...</p>
            </div>
        </div>

        <!-- Supplier Details -->
        <div *ngIf="!loading && supplier" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Contact Info & Stats -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Financial Status Card -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">الوضع المالي</h2>
                        <i class="pi pi-chart-line text-blue-600 text-2xl"></i>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100">
                            <div class="text-sm text-gray-600 font-medium mb-2">الرصيد الحالي</div>
                            <div class="text-3xl font-bold text-blue-700">
                                {{ (supplier.balance || 0) | currency:'YER ':'symbol':'1.0-0' }}
                            </div>
                        </div>

                        <div
                            class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100">
                            <div class="text-sm text-gray-600 font-medium mb-2">إجمالي المشتريات</div>
                            <div class="text-2xl font-bold text-green-700">
                                {{ getTotalPurchases() | currency:'YER ':'symbol':'1.0-0' }}
                            </div>
                        </div>

                        <div
                            class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-4 border border-orange-100">
                            <div class="text-sm text-gray-600 font-medium mb-2">إجمالي المرتجعات</div>
                            <div class="text-2xl font-bold text-orange-700">
                                {{ getTotalReturns() | currency:'YER ':'symbol':'1.0-0' }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Information Card -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">معلومات التواصل</h2>

                    <div class="space-y-4">
                        <!-- Contact Person -->
                        <div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg transition-colors">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="pi pi-user text-blue-600"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">المسؤول المباشر</div>
                                <div class="font-bold text-gray-800">{{ supplier.contactPerson || 'غير محدد' }}</div>
                            </div>
                        </div>

                        <!-- Phone -->
                        <div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg transition-colors">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="pi pi-phone text-green-600"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">رقم الهاتف</div>
                                <div class="font-bold text-gray-800 font-mono">{{ supplier.phoneNumber }}</div>
                            </div>
                            <a *ngIf="supplier.phoneNumber" [href]="'tel:' + supplier.phoneNumber"
                                class="p-button p-button-rounded p-button-text text-green-600 hover:text-green-700">
                                <i class="pi pi-phone"></i>
                            </a>
                        </div>

                        <!-- Email -->
                        <div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg transition-colors">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="pi pi-envelope text-purple-600"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">البريد الإلكتروني</div>
                                <div class="font-bold text-gray-800 truncate">{{ supplier.email || 'غير مسجل' }}</div>
                            </div>
                            <a *ngIf="supplier.email" [href]="'mailto:' + supplier.email"
                                class="p-button p-button-rounded p-button-text text-purple-600 hover:text-purple-700">
                                <i class="pi pi-send"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Main Details & Transactions -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Basic Information Card -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-2 h-8 bg-blue-600 rounded-full"></div>
                        <h2 class="text-2xl font-bold text-gray-800">المعلومات الأساسية</h2>
                    </div>

                    <!-- Address -->
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="pi pi-map-marker text-blue-600"></i>
                            <span class="font-bold text-gray-700">العنوان الجغرافي</span>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                            <p class="text-gray-700 text-lg leading-relaxed">
                                {{ supplier.address }}
                            </p>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="pi pi-info-circle text-amber-600"></i>
                            <span class="font-bold text-gray-700">ملاحظات إضافية</span>
                        </div>
                        <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
                            <p class="text-gray-700 italic leading-relaxed" [class.text-gray-400]="!supplier.notes">
                                {{ supplier.notes || 'لا توجد ملاحظات إضافية لهذا المورد.' }}
                            </p>
                        </div>
                    </div>

                    <!-- Timestamps -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <div class="text-sm text-gray-500 mb-2">تاريخ الإنشاء</div>
                            <div class="flex items-center gap-2">
                                <i class="pi pi-calendar-plus text-blue-600"></i>
                                <span class="font-bold text-gray-800">
                                    {{ supplier.createdAt ? (supplier.createdAt | date:'fullDate') : 'غير محدد' }}
                                </span>
                            </div>
                        </div>

                        <div *ngIf="supplier.updatedAt">
                            <div class="text-sm text-gray-500 mb-2">آخر تحديث</div>
                            <div class="flex items-center gap-2">
                                <i class="pi pi-history text-green-600"></i>
                                <span class="font-bold text-gray-800">
                                    {{ supplier.updatedAt | date:'medium' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Section -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">التعاملات المالية</h2>
                        <div class="text-lg font-bold text-gray-700">
                            إجمالي التعاملات: {{ getTotalTransactions() | currency:'YER ':'symbol':'1.0-0' }}
                        </div>
                    </div>

                    <!-- Purchase Invoices -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <i class="pi pi-shopping-cart text-blue-600"></i>
                                <h3 class="text-xl font-bold text-gray-700">فواتير الشراء</h3>
                                <span class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full">
                                    {{ supplier.purchaseInvoices?.length || 0 }}
                                </span>
                            </div>
                            <button aria-label="edit" pButton pRipple [label]="showInvoices ? 'إخفاء' : 'عرض'" icon="pi pi-list"
                                class="p-button-outlined p-button-sm" (click)="toggleInvoices()"></button>
                        </div>

                        <div *ngIf="showInvoices && supplier.purchaseInvoices?.length">
                            <p-table [value]="supplier.purchaseInvoices!" styleClass="p-datatable-sm">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th class="text-right">رقم الفاتورة</th>
                                        <th class="text-right">التاريخ</th>
                                        <th class="text-right">المبلغ</th>
                                        <th class="text-right">الحالة</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-invoice>
                                    <tr>
                                        <td>#{{ invoice.id }}</td>
                                        <td>{{ invoice.date | date:'shortDate' }}</td>
                                        <td class="font-bold text-blue-700">
                                            {{ invoice.totalAmount | currency:'YER ':'symbol':'1.0-0' }}
                                        </td>
                                        <td>
                                            <p-tag [severity]="invoice.status === 'Paid' ? 'success' : 'warning'"
                                                [value]="invoice.status === 'Paid' ? 'مدفوعة' : 'غير مدفوعة'"></p-tag>
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>

                        <div *ngIf="showInvoices && !supplier.purchaseInvoices?.length"
                            class="text-center py-8 text-gray-500">
                            <i class="pi pi-inbox text-4xl mb-2"></i>
                            <p>لا توجد فواتير شراء</p>
                        </div>
                    </div>

                    <!-- Purchase Returns -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <i class="pi pi-arrow-left text-orange-600"></i>
                                <h3 class="text-xl font-bold text-gray-700">مرتجعات الشراء</h3>
                                <span class="bg-orange-100 text-orange-800 text-sm font-medium px-3 py-1 rounded-full">
                                    {{ supplier.purchaseReturns?.length || 0 }}
                                </span>
                            </div>
                            <button aria-label="edit" pButton pRipple [label]="showReturns ? 'إخفاء' : 'عرض'" icon="pi pi-list"
                                class="p-button-outlined p-button-sm" (click)="toggleReturns()"></button>
                        </div>

                        <div *ngIf="showReturns && supplier.purchaseReturns?.length">
                            <p-table [value]="supplier.purchaseReturns!" styleClass="p-datatable-sm">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th class="text-right">رقم المرتجع</th>
                                        <th class="text-right">التاريخ</th>
                                        <th class="text-right">المبلغ</th>
                                        <th class="text-right">السبب</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-return>
                                    <tr>
                                        <td>#{{ return.id }}</td>
                                        <td>{{ return.date | date:'shortDate' }}</td>
                                        <td class="font-bold text-orange-700">
                                            {{ return.totalAmount | currency:'YER ':'symbol':'1.0-0' }}
                                        </td>
                                        <td>{{ return.reason || 'غير محدد' }}</td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>

                        <div *ngIf="showReturns && !supplier.purchaseReturns?.length"
                            class="text-center py-8 text-gray-500">
                            <i class="pi pi-inbox text-4xl mb-2"></i>
                            <p>لا توجد مرتجعات شراء</p>
                        </div>
                    </div>
                </div>

                <!-- Status Tags -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex flex-wrap gap-2">
                        <p-tag severity="success" value="نشط" icon="pi pi-check-circle" styleClass="px-4 py-2"></p-tag>
                        <p-tag severity="info" value="مورد معتمد" icon="pi pi-star" styleClass="px-4 py-2"></p-tag>
                        <p-tag *ngIf="supplier.balance && supplier.balance > 0" severity="warning" value="لديه مديونية"
                            icon="pi pi-exclamation-triangle" styleClass="px-4 py-2"></p-tag>
                        <p-tag *ngIf="supplier.purchaseInvoices && supplier.purchaseInvoices.length > 0"
                            [severity]="'secondary'" [value]="'مشتريات: ' + supplier.purchaseInvoices.length"
                            icon="pi pi-shopping-cart" styleClass="px-4 py-2"></p-tag>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!loading && !supplier" class="flex justify-center items-center min-h-[400px]">
            <div class="text-center">
                <i class="pi pi-exclamation-circle text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-600 mb-2">لم يتم العثور على المورد</h3>
                <p class="text-gray-400 mb-4">تعذر تحميل بيانات المورد المطلوب</p>
                <button aria-label="edit" pButton label="العودة للقائمة" icon="pi pi-arrow-right" class="p-button-outlined"
                    (click)="goBack()"></button>
            </div>
        </div>
    </div>
</div>

<p-confirmDialog [rtl]="true" styleClass="max-w-md rounded-xl shadow-2xl"
    rejectButtonStyleClass="p-button-text p-button-sm"
    acceptButtonStyleClass="p-button-danger p-button-sm"></p-confirmDialog>

<p-toast position="bottom-left"></p-toast>
