<div class="card p-0 shadow-3 border-round-xl overflow-hidden" [class.opacity-80]="loading" dir="rtl">
    <!-- Header Section -->
    <div class="bg-indigo-600 p-4 text-white flex justify-content-between align-items-center">
        <div class="flex align-items-center gap-3">
            <i class="pi pi-cart-plus text-3xl"></i>
            <div>
                <h2 class="m-0 text-xl font-bold">فاتورة مشتريات</h2>
                <small class="opacity-80">تسجيل وتوريد الأدوية للمستودع</small>
            </div>
        </div>
        <div class="flex align-items-center gap-3">
            <p-tag [severity]="getStatusSeverity(purchaseForm.get('status')?.value)"
                [value]="getStatusLabel(purchaseForm.get('status')?.value)" styleClass="text-lg px-3 py-2"></p-tag>
            <div class="flex gap-2">
                <p-button *ngIf="purchaseForm.get('status')?.value === 'Draft'" label="حفظ كمسودة" icon="pi pi-save"
                    severity="info" (onClick)="saveDraft()" [loading]="loading"></p-button>
                <p-button *ngIf="purchaseForm.get('status')?.value === 'Draft'" label="اعتماد المشتريات"
                    icon="pi pi-check" severity="success" (onClick)="approveInvoice()" [loading]="loading"
                    [disabled]="purchaseForm.invalid || !currentInvoice"></p-button>
                <p-button *ngIf="purchaseForm.get('status')?.value === 'Approved'" label="إلغاء المشتريات"
                    icon="pi pi-times" severity="danger" (onClick)="cancelInvoice()" [loading]="loading"></p-button>
                <p-button label="رجوع" icon="pi pi-arrow-left" severity="secondary" outlined
                    (onClick)="cancel()"></p-button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <form [formGroup]="purchaseForm" class="p-4 bg-gray-50">
        <!-- Purchase Header Row -->
        <div class="grid p-fluid">
            <div class="col-12 md:col-2">
                <label class="block font-bold mb-2 text-secondary">رقم الفاتورة</label>
                <input pInputText formControlName="invoiceNumber" placeholder="تلقائي..."
                    class="bg-gray-100 font-bold" />
            </div>
            <div class="col-12 md:col-3">
                <label class="block font-bold mb-2 text-secondary">المورد</label>
                <p-autoComplete *ngIf="!isReadOnly; else supplierNameRead" [suggestions]="filteredSuppliers"
                    (completeMethod)="searchSuppliers($event)" field="name" formControlName="supplierId"
                    placeholder="ابحث عن مورد..." appendTo="body" [dropdown]="true"></p-autoComplete>
                <ng-template #supplierNameRead>
                    <input pInputText formControlName="supplierName" class="bg-gray-100" />
                </ng-template>
            </div>
            <div class="col-12 md:col-3">
                <label class="block font-bold mb-2 text-secondary">تاريخ الشراء</label>
                <p-calendar formControlName="purchaseInvoiceDate" [showIcon]="true" dateFormat="dd/mm/yy"
                    appendTo="body"></p-calendar>
            </div>
            <div class="col-12 md:col-2">
                <label class="block font-bold mb-2 text-secondary">طريقة الدفع</label>
                <p-dropdown [options]="paymentMethods" formControlName="paymentMethod" appendTo="body"></p-dropdown>
            </div>
            <div class="col-12 md:col-2">
                <label class="block font-bold mb-2 text-secondary">ملاحظات</label>
                <input pInputText formControlName="notes" placeholder="..." />
            </div>
        </div>

        <p-divider align="right" styleClass="my-5">
            <span class="flex align-items-center gap-2 text-indigo-600 font-bold">
                <i class="pi pi-database"></i> بنود التوريد
            </span>
        </p-divider>

        <!-- Details Grid -->
        <p-table [value]="items.controls" responsiveLayout="scroll"
            styleClass="p-datatable-gridlines p-datatable-sm shadow-1">
            <ng-template pTemplate="header">
                <tr>
                    <th class="bg-white text-right p-3" style="min-width: 250px">الصنف</th>
                    <th class="bg-white text-center p-3" style="width: 150px">رقم الدفعة</th>
                    <th class="bg-white text-center p-3" style="width: 180px">تاريخ الانتهاء</th>
                    <th class="bg-white text-center p-3" style="width: 120px">الكمية</th>
                    <th class="bg-white text-center p-3" style="width: 150px">سعر الشراء</th>
                    <th class="bg-white text-center p-3" style="width: 150px">الإجمالي</th>
                    <th *ngIf="!isReadOnly" class="bg-white text-center p-3" style="width: 50px"></th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item let-i="rowIndex">
                <tr [formGroup]="$any(item)" class="bg-white">
                    <td class="p-2">
                        <p-autoComplete *ngIf="!isReadOnly; else medicineNameRead" [suggestions]="filteredMedicines"
                            (completeMethod)="searchMedicines($event)" field="name"
                            (onSelect)="onMedicineSelect($event.value, i)" placeholder="ابحث..." styleClass="w-full"
                            appendTo="body" [forceSelection]="true"></p-autoComplete>
                        <ng-template #medicineNameRead>
                            <span class="font-bold">{{item.get('medicineName')?.value}}</span>
                        </ng-template>
                    </td>
                    <td class="p-2">
                        <input pInputText formControlName="companyBatchNumber" placeholder="Batch #"
                            class="text-center font-mono" [disabled]="isReadOnly" />
                    </td>
                    <td class="p-2">
                        <p-calendar formControlName="expiryDate" view="month" dateFormat="mm/yy" [showIcon]="true"
                            appendTo="body" placeholder="شهر/سنة" [disabled]="isReadOnly"></p-calendar>
                    </td>
                    <td class="p-2">
                        <p-inputNumber formControlName="quantity" [min]="1" styleClass="w-full"
                            inputStyleClass="text-center font-bold" [disabled]="isReadOnly"></p-inputNumber>
                    </td>
                    <td class="p-2">
                        <p-inputNumber formControlName="purchasePrice" mode="currency" currency="EGP"
                            styleClass="w-full" inputStyleClass="text-center" [disabled]="isReadOnly"></p-inputNumber>
                    </td>
                    <td class="p-2 text-center font-bold text-indigo-600">
                        {{item.get('total')?.value | currency:'EGP'}}
                    </td>
                    <td *ngIf="!isReadOnly" class="p-2 text-center">
                        <button pButton icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-text"
                            (click)="removeItem(i)"></button>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="footer" *ngIf="!isReadOnly">
                <tr>
                    <td colspan="7" class="p-3 text-right">
                        <p-button label="إضافة صنف" icon="pi pi-plus" severity="secondary" outlined size="small"
                            (onClick)="addItem()"></p-button>
                    </td>
                </tr>
            </ng-template>
        </p-table>

        <!-- Summary Panel -->
        <div class="grid mt-5 justify-content-end">
            <div class="col-12 md:col-4">
                <div class="bg-white border-round-xl shadow-1 p-4 border-1 border-indigo-100">
                    <div class="flex justify-content-between py-2 border-bottom-1 border-gray-100">
                        <span class="text-secondary font-bold">إجمالي الفاتورة:</span>
                        <span class="text-2xl font-extrabold text-indigo-600">{{currentInvoice?.totalAmount || 0 |
                            currency:'EGP'}}</span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>