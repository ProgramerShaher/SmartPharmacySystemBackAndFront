<div class="page-container animate-fade-in" dir="rtl">
  <!-- Header -->
  <header class="page-header glass-panel mb-4">
    <div class="header-content">
      <div class="title-section">
        <div class="icon-wrapper ledger">
          <i class="pi pi-book"></i>
        </div>
        <div class="text-wrapper">
          <h1 class="m-0 text-3xl font-bold">دفتر الأستاذ العام</h1>
          <p class="m-0 opacity-70">سجل شامل لجميع الحركات المالية</p>
        </div>
      </div>
      <div class="action-section flex gap-2">
        <p-button 
          label="تصدير Excel" 
          icon="pi pi-file-excel" 
          severity="success" 
          outlined
          (onClick)="exportToExcel()">
        </p-button>
        <p-button 
          label="تحديث" 
          icon="pi pi-refresh" 
          severity="secondary" 
          outlined
          (onClick)="loadLedger()">
        </p-button>
      </div>
    </div>
  </header>

  <!-- Filters -->
  <div class="glass-panel p-4 mb-4">
    <div class="grid align-items-end">
      <div class="col-12 md:col-6 lg:col-4">
        <label class="font-bold text-sm block mb-2">فترة التقرير</label>
        <p-calendar 
          [(ngModel)]="dateRange" 
          selectionMode="range" 
          [showIcon]="true"
          dateFormat="dd/mm/yy"
          placeholder="اختر الفترة..."
          styleClass="w-full"
          (onSelect)="onDateFilter()">
        </p-calendar>
      </div>
      <div class="col-12 md:col-6 lg:col-2">
        <p-button 
          label="مسح الفلاتر" 
          icon="pi pi-filter-slash" 
          severity="secondary" 
          outlined
          styleClass="w-full"
          (onClick)="clearFilters()">
        </p-button>
      </div>
    </div>
  </div>

  <!-- Ledger Table -->
  <div class="glass-panel p-0 overflow-hidden">
    <p-table 
      [value]="ledgerEntries()" 
      [loading]="loading()"
      [paginator]="true"
      [rows]="pageSize()"
      [totalRecords]="totalRecords()"
      [lazy]="true"
      (onLazyLoad)="onPageChange($event)"
      responsiveLayout="scroll"
      styleClass="p-datatable-sm"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="عرض {first} إلى {last} من أصل {totalRecords}">
      
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 120px">التاريخ</th>
          <th>البيان</th>
          <th style="width: 150px">نوع العملية</th>
          <th style="width: 120px">المرجع</th>
          <th class="text-right" style="width: 130px">مدين</th>
          <th class="text-right" style="width: 130px">دائن</th>
          <th class="text-right" style="width: 150px">الرصيد الجاري</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-entry>
        <tr class="fadein">
          <td>
            <div class="flex align-items-center gap-2">
              <i class="pi pi-calendar text-sm opacity-50"></i>
              <span class="text-sm">{{ entry.transactionDate | date:'dd/MM/yyyy' }}</span>
            </div>
          </td>
          <td>
            <span class="font-medium">{{ entry.description }}</span>
            <small class="block text-500 mt-1">{{ entry.category }}</small>
          </td>
          <td>
            <p-tag 
              [value]="getReferenceTypeLabel(entry.referenceType)" 
              [severity]="getReferenceTypeSeverity(entry.referenceType)"
              styleClass="shadow-sm">
            </p-tag>
          </td>
          <td class="text-center">
            <span class="font-mono text-sm font-bold text-primary">{{ entry.referenceNumber }}</span>
          </td>
          <td class="text-right">
            <span *ngIf="entry.outgoing > 0" class="font-bold text-red-600">
              {{ entry.outgoing | number:'1.0-2' }}
            </span>
            <span *ngIf="entry.outgoing === 0" class="opacity-30">-</span>
          </td>
          <td class="text-right">
            <span *ngIf="entry.incoming > 0" class="font-bold text-green-600">
              {{ entry.incoming | number:'1.0-2' }}
            </span>
            <span *ngIf="entry.incoming === 0" class="opacity-30">-</span>
          </td>
          <td class="text-right">
            <div class="balance-cell" [ngClass]="{'negative': entry.runningBalance < 0}">
              <span class="font-bold text-lg">{{ entry.runningBalance | number:'1.0-2' }}</span>
              <small class="block text-xs opacity-70">ر.ي</small>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center p-6 opacity-40">
            <i class="pi pi-inbox text-6xl mb-3"></i>
            <p class="m-0 text-xl">لا توجد حركات مالية في الفترة المحددة</p>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="loadingbody">
        <tr>
          <td colspan="7" class="text-center p-6">
            <p-progressSpinner strokeWidth="3"></p-progressSpinner>
            <p class="mt-3 text-lg">جاري تحميل البيانات...</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<p-toast></p-toast>
